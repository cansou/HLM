<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lj.business.member.dao.IPersonMemberDao" >
  <resultMap id="BaseResultMap" type="com.lj.business.member.domain.PersonMember" >
    <id column="CODE" property="code" jdbcType="VARCHAR" />
    <result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME" property="memberName" jdbcType="VARCHAR" />
    <result column="MEMBER_NO_GM" property="memberNoGm" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME_GM" property="memberNameGm" jdbcType="VARCHAR" />
    <result column="MERCHANT_NO" property="merchantNo" jdbcType="VARCHAR" />
    <result column="MERCHANT_NAME" property="merchantName" jdbcType="VARCHAR" />
    <result column="SPRUCE_UP" property="spruceUp" jdbcType="VARCHAR" />
    <result column="HOUSES" property="houses" jdbcType="VARCHAR" />
    <result column="KEEP_EYE" property="keepEye" jdbcType="VARCHAR" />
    <result column="URGENCY_PM" property="urgencyPm" jdbcType="VARCHAR" />
    <result column="BOM_CODE" property="bomCode" jdbcType="VARCHAR" />
    <result column="BOM_NAME" property="bomName" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_LOCAL" property="nickNameRemarkLocal" jdbcType="VARCHAR" />
    <result column="CONTACT_DATE_LAST" property="contactDateLast" jdbcType="TIMESTAMP" />
    <result column="BRAND_COMPARE" property="brandCompare" jdbcType="VARCHAR" />
    <result column="CLIENT_SPECIAL" property="clientSpecial" jdbcType="VARCHAR" />
    <result column="CONSUME_FREQUENCY" property="consumeFrequency" jdbcType="INTEGER" />
    <result column="SCAN_ADDRESS" property="scanAddress" jdbcType="VARCHAR" />
    <result column="LATITUDE" property="latitude" jdbcType="VARCHAR" />
    <result column="LONGITUDE" property="longitude" jdbcType="VARCHAR" />
    <result column="FIRST_INTRODUCE" property="firstIntroduce" jdbcType="VARCHAR" />
    <result column="EXPECT_PURCHASE_TIME" property="expectPurchaseTime" jdbcType="TIMESTAMP" />
    <result column="EXP_TIME" property="expTime" jdbcType="TIMESTAMP" />
    <result column="WX_FRIENDS" property="wxFriends" jdbcType="INTEGER" />
    <result column="ADD_TYPE" property="addType" jdbcType="INTEGER" />
    <result column="VERSION" property="version" jdbcType="BIGINT" />
    <result column="CREATE_ID" property="createId" jdbcType="VARCHAR" />
    <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="UPDATE_ID" property="updateId" jdbcType="VARCHAR" />
    <result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP" />
    <result column="REMARK4" property="remark4" jdbcType="VARCHAR" />
    <result column="REMARK3" property="remark3" jdbcType="VARCHAR" />
    <result column="REMARK2" property="remark2" jdbcType="VARCHAR" />
    <result column="set_up_user" property="setUpUser" jdbcType="VARCHAR" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="CONTACT_DATE_LAST" property="contactDateLast" jdbcType="TIMESTAMP" />
    <!-- 客户分类 -->
    <result column="PM_TYPE_CODE" property="pmTypeCode" jdbcType="VARCHAR" />
    <result column="PM_TYPE_NAME" property="pmTypeName" jdbcType="VARCHAR" />
    <result column="SHOP_WX" property="shopWx" jdbcType="VARCHAR" />
  </resultMap>
  
  <resultMap id="findPersonMemberPageResultMap" type="com.lj.business.member.dto.FindPersonMemberPageReturn" >
  <!-- 		客户信息 -->
     <id column="CODE" property="code" jdbcType="VARCHAR" />
    <result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME" property="memberName" jdbcType="VARCHAR" />
    <result column="MEMBER_NO_GM" property="memberNoGm" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME_GM" property="memberNameGm" jdbcType="VARCHAR" />
    <result column="MERCHANT_NO" property="merchantNo" jdbcType="VARCHAR" />
    <result column="MERCHANT_NAME" property="merchantName" jdbcType="VARCHAR" />
    <result column="SPRUCE_UP" property="spruceUp" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" jdbcType="VARCHAR" />
    <result column="set_up_user" property="setUpUser" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" jdbcType="VARCHAR" />
    
    <result column="HOUSES" property="houses" jdbcType="VARCHAR" />
    <result column="BRAND_COMPARE" property="brandCompare" jdbcType="VARCHAR" />
    <result column="KEEP_EYE" property="keepEye" jdbcType="VARCHAR" />
    <result column="URGENCY_PM" property="urgencyPm" jdbcType="VARCHAR" />
    <result column="BOM_CODE" property="bomCode" jdbcType="VARCHAR" />
    <result column="BOM_NAME" property="bomName" jdbcType="VARCHAR" />
    <result column="BRAND_COMPARE" property="brandCompare" jdbcType="VARCHAR" />
    <result column="CLIENT_SPECIAL" property="clientSpecial" jdbcType="VARCHAR" />
    <result column="CONSUME_FREQUENCY" property="consumeFrequency" jdbcType="INTEGER" />
    <result column="ADD_TYPE" property="addType" jdbcType="INTEGER" />
    <result column="CREATE_ID" property="createId" jdbcType="VARCHAR" />
    <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="UPDATE_ID" property="updateId" jdbcType="VARCHAR" />
    <result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP" />
    <result column="REMARK4" property="remark4" jdbcType="VARCHAR" />
    <result column="REMARK3" property="remark3" jdbcType="VARCHAR" />
    <result column="REMARK2" property="remark2" jdbcType="VARCHAR" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <!-- 		客户基础信息 -->
    <result column="STATUS" property="status" jdbcType="VARCHAR" />
    <result column="CERT_TYPE_CODE" property="certTypeCode" jdbcType="VARCHAR" />
    <result column="CERT_NO" property="certNo" jdbcType="VARCHAR" />
    <result column="MOBILE" property="mobile" jdbcType="VARCHAR" />
    <result column="IMEI" property="imei" jdbcType="VARCHAR" />
    <result column="EMAIL" property="email" jdbcType="VARCHAR" />
    <result column="JOB" property="job" jdbcType="VARCHAR" />
    <result column="ADDRESS" property="address" jdbcType="VARCHAR" />
    <result column="AGE" property="age" jdbcType="INTEGER" />
    <result column="SEX" property="sex" jdbcType="VARCHAR" />
    <result column="NAME_AUTH_FLAG" property="nameAuthFlag" jdbcType="CHAR" />
    <result column="PWD" property="pwd" jdbcType="VARCHAR" />
    <result column="ENCRYPTION_CODE" property="encryptionCode" jdbcType="VARCHAR" />
    <result column="MEMBER_SRC" property="memberSrc" jdbcType="VARCHAR" />
    <result column="OPEN_ID_GZH_WX" property="openIdGzhWx" jdbcType="VARCHAR" />
    <result column="OPEN_ID_XCX_WX" property="openIdXcxWx" jdbcType="VARCHAR" />
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_WX" property="nickNameWx" jdbcType="VARCHAR" />
    <result column="CITY_WX" property="cityWx" jdbcType="VARCHAR" />
    <result column="COUNTRY_WX" property="countryWx" jdbcType="VARCHAR" />
    <result column="PROVINCE_WX" property="provinceWx" jdbcType="VARCHAR" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
    <result column="SUBSRIBE_TIME" property="subsribeTime" jdbcType="TIMESTAMP" />
    <result column="FAMILY_CODE" property="familyCode" jdbcType="VARCHAR" />
    <result column="FAMILY_NAME" property="familyName" jdbcType="VARCHAR" />
    <result column="INTEREST" property="interest" jdbcType="VARCHAR" />
    <result column="CONSTELLATION" property="constellation" jdbcType="VARCHAR" />
    <result column="AREA_CODE" property="areaCode" jdbcType="VARCHAR" />
    <result column="PROVINCE_CODE" property="provinceCode" jdbcType="VARCHAR" />
    <result column="CITY_CODE" property="cityCode" jdbcType="VARCHAR" />
    <result column="CITY_AREA_CODE" property="cityAreaCode" jdbcType="VARCHAR" />
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
    <result column="NO_WX_ALIAS" property="noWxAlias" jdbcType="VARCHAR" />
    <result column="BIRTHDAY" property="birthday" jdbcType="TIMESTAMP" />
    <result column="WX_OPENID" property="wxOpenId" jdbcType="VARCHAR" />
    
    <!-- 客户分类 -->
    <result column="PM_TYPE_CODE" property="pmTypeCode" jdbcType="VARCHAR" />
    <result column="PM_TYPE_NAME" property="pmTypeName" jdbcType="VARCHAR" />
   	<result column="PM_TYPE_DIM" property="pmTypeDim" jdbcType="VARCHAR" />
   	<result column="PM_TYPE_STATUS" property="pmTypeStatus" jdbcType="VARCHAR" />
   	 <!-- 		跟进、维护、放弃记录次数 -->
   	<result column="FOLLOW_NUM" property="followNum" jdbcType="VARCHAR" />
   	<result column="KEEP_NUM" property="keepNum" jdbcType="VARCHAR" />
   	<result column="PA_NUM" property="paNum" jdbcType="VARCHAR" />
   	 <!-- 		导购头像 -->
   	<result column="GMPHOTO" property="gmPhoto" jdbcType="VARCHAR" />
   	<result column="BASE_CODE" property="baseCode" jdbcType="VARCHAR" />
   	<result column="SHOP_WX" property="shopWx" jdbcType="VARCHAR" />
   	
   	 <result column="NO_WW" property="noWw" jdbcType="VARCHAR" />
  </resultMap>
  
  <resultMap id="findPmTypeIndexPageResultMap" type="com.lj.business.member.dto.FindPmTypeIndexPageReturn" >
    <result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME" property="memberName" jdbcType="VARCHAR" />
    <result column="MEMBER_NO_GM" property="memberNoGm" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME_GM" property="memberNameGm" jdbcType="VARCHAR" />
    <result column="MOBILE" property="mobile" jdbcType="VARCHAR" />
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_LOCAL" property="nickNameRemarkLocal" jdbcType="VARCHAR" />
    <result column="NICK_NAME_WX" property="nickNameWx" jdbcType="VARCHAR" />
    <result column="WX_FRIENDS" property="wxFriends" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
    <result column="BEHAVIOR_DESC" property="behaviorDesc" jdbcType="VARCHAR" />
    <result column="BEHAVIOR_DATE" property="behaviorDate" jdbcType="TIMESTAMP" />
    <result column="CODE" property="codePmTypePm" jdbcType="VARCHAR" />
   <result column="URGENCY_PM" property="urgencyPm" jdbcType="VARCHAR" />
   <result column="RATIO_CLIENT_INFO" property="ratioClientInfo" jdbcType="DECIMAL" />
   <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
   <result column="CONSUME_FREQUENCY" property="consumeFrequency" jdbcType="INTEGER" />
   <result column="SHOP_WX" property="shopWx" jdbcType="VARCHAR" />
<!--    <result column="set_up_user" property="setUpUser" jdbcType="VARCHAR" /> 
   <collection property="labels" ofType="com.lj.business.member.dto.PmLabelDto">
   	<id column="LABEL_CODE" property="code" />
   	<result column="LABEL_NAME" property="labelName" />
   </collection>-->
  </resultMap>
  <resultMap id="findPmSeachPageResultMap" type="com.lj.business.member.dto.FindPmSeachPageReturn" >
    <result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME" property="memberName" jdbcType="VARCHAR" />
    <result column="MEMBER_NO_GM" property="memberNoGm" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME_GM" property="memberNameGm" jdbcType="VARCHAR" />
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
    <result column="MOBILE" property="mobile" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_LOCAL" property="nickNameRemarkLocal" jdbcType="VARCHAR" />
    <result column="WX_FRIENDS" property="wxFriends" />
    <result column="NICK_NAME_WX" property="nickNameWx" jdbcType="VARCHAR" />
    <result column="RATIO_CLIENT_INFO" property="ratioClientInfo" jdbcType="DECIMAL" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
    <result column="BEHAVIOR_DESC" property="behaviorDesc" jdbcType="VARCHAR" />
    <result column="BEHAVIOR_DATE" property="behaviorDate" jdbcType="TIMESTAMP" />
<!--     <result column="set_up_user" property="setUpUser" jdbcType="VARCHAR" /> -->
    <result column="SHOP_WX" property="shopWx" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="findUrgentMbrPageResultMap" type="com.lj.business.member.dto.FindUrgentMbrPageReturn" >
    <result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME" property="memberName" jdbcType="VARCHAR" />
    <result column="MEMBER_NO_GM" property="memberNoGm" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME_GM" property="memberNameGm" jdbcType="VARCHAR" />
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_WX" property="nickNameWx" jdbcType="VARCHAR" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
    <result column="BEHAVIOR_DESC" property="behaviorDesc" jdbcType="VARCHAR" />
    <result column="SEX" property="sex" jdbcType="VARCHAR" />
<!--     <result column="set_up_user" property="setUpUser" jdbcType="VARCHAR" /> -->
  </resultMap>
  <resultMap id="findPmWxBpInfoResultMap" type="com.lj.business.member.dto.FindPmWxBpInfoReturn" >
  	<result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_LOCAL" property="nickNameRemarkLocal" jdbcType="VARCHAR" />
    <result column="NICK_NAME_WX" property="nickNameWx" jdbcType="VARCHAR" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
    <result column="BEHAVIOR_DESC" property="behaviorDesc" jdbcType="VARCHAR" />
    <result column="BEHAVIOR_DATE" property="behaviorDate" jdbcType="TIMESTAMP" />
<!--     <result column="set_up_user" property="setUpUser" jdbcType="VARCHAR" /> -->
  </resultMap>
  <resultMap id="findNewPmPageResultMap" type="com.lj.business.member.dto.FindNewPmPageReturn" >
    <result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME" property="memberName" jdbcType="VARCHAR" />
    <result column="MOBILE" property="mobile" jdbcType="VARCHAR" />
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_LOCAL" property="nickNameRemarkLocal" jdbcType="VARCHAR" />
    <result column="NICK_NAME_WX" property="nickNameWx" jdbcType="VARCHAR" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
    <result column="REMARK_COM" property="remarkCom" jdbcType="VARCHAR" />
    <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="UNGROUP" property="unGroup" jdbcType="VARCHAR" />
    <result column="COMPLETE" property="complete" jdbcType="VARCHAR" />
    <result column="set_up_user" property="setUpUser" jdbcType="VARCHAR" />
    <result column="RATIO_CLIENT_INFO" property="ratioClientInfo" jdbcType="DECIMAL" />
    <result column="FIRST_INTRODUCE" property="firstIntroduce" jdbcType="VARCHAR" />
  </resultMap>

    <resultMap id="findUnContactMemberResultMap" type="com.lj.business.member.dto.FindUnContactMemberReturn" >
        <result column="MEMBER_NO" property="memberNo" />
        <result column="MEMBER_NAME" property="memberName" />
        <result column="MOBILE" property="mobile" />
        <result column="NO_WX" property="noWx" />
        <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" />
    	<result column="NICK_NAME_REMARK_LOCAL" property="nickNameRemarkLocal" jdbcType="VARCHAR" />
        <result column="NICK_NAME_WX" property="nickNameWx" />
        <result column="WX_FRIENDS" property="wxFriends" />
        <result column="HEAD_ADDRESS" property="imgAddr" />
        <result column="BEHAVIOR_DATE" property="behaviorDate" />
        <result column="BEHAVIOR_DESC" property="behaviorDesc" />
    </resultMap>
    
    <resultMap id="findUnContactMemberByPmTypeResultMap" type="com.lj.business.member.dto.FindUnContactMemberReturn" >
        <result column="MEMBER_NO" property="memberNo" />
        <result column="MEMBER_NAME" property="memberName" />
        <result column="MOBILE" property="mobile" />
        <result column="NO_WX" property="noWx" />
        <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" />
        <result column="NICK_NAME_WX" property="nickNameWx" />
        <result column="HEAD_ADDRESS" property="imgAddr" />
        <result column="BEHAVIOR_DATE" property="behaviorDate" />
        <result column="BEHAVIOR_DESC" property="behaviorDesc" />
        <result column="WX_FRIENDS" property="wxFriends" />
        
        <collection property="pmLabels" ofType="com.lj.business.member.domain.PmLabel">
        	<id column="LABEL_CODE" property="code"/>
        	<result column="LABEL_NAME" property="labelName" />
        </collection>
    </resultMap>

   <resultMap id="findPmWxInfoResultMap" type="com.lj.business.member.dto.FindPmWxInfoReturn" >
  	<result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
  	<result column="MOBILE" property="mobile" jdbcType="VARCHAR" />
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_LOCAL" property="nickNameRemarkLocal" jdbcType="VARCHAR" />
    <result column="NICK_NAME_WX" property="nickNameWx" jdbcType="VARCHAR" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
<!--     <result column="BEHAVIOR_DESC" property="behaviorDesc" jdbcType="VARCHAR" /> -->
<!--     <result column="BEHAVIOR_DATE" property="behaviorDate" jdbcType="TIMESTAMP" /> -->
    <result column="SEX" property="sex" jdbcType="VARCHAR" />
    <result column="WX_OPENID" property="wxOpenId" jdbcType="VARCHAR" />
  </resultMap>
  
  <resultMap id="findListResultMap" type="com.lj.business.member.dto.FindPersonMemberReturn" >
    <id column="CODE" property="code" jdbcType="VARCHAR" />
    <result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME" property="memberName" jdbcType="VARCHAR" />
    <result column="MEMBER_NO_GM" property="memberNoGm" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME_GM" property="memberNameGm" jdbcType="VARCHAR" />
    <result column="MERCHANT_NO" property="merchantNo" jdbcType="VARCHAR" />
    <result column="MERCHANT_NAME" property="merchantName" jdbcType="VARCHAR" />
    <result column="SPRUCE_UP" property="spruceUp" jdbcType="VARCHAR" />
    <result column="HOUSES" property="houses" jdbcType="VARCHAR" />
    <result column="KEEP_EYE" property="keepEye" jdbcType="VARCHAR" />
    <result column="URGENCY_PM" property="urgencyPm" jdbcType="VARCHAR" />
    <result column="BOM_CODE" property="bomCode" jdbcType="VARCHAR" />
    <result column="BOM_NAME" property="bomName" jdbcType="VARCHAR" />
    <result column="CREATE_ID" property="createId" jdbcType="VARCHAR" />
    <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="UPDATE_ID" property="updateId" jdbcType="VARCHAR" />
    <result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP" />
    <result column="REMARK4" property="remark4" jdbcType="VARCHAR" />
    <result column="REMARK3" property="remark3" jdbcType="VARCHAR" />
    <result column="REMARK2" property="remark2" jdbcType="VARCHAR" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
    <result column="NICK_NAME_REMARK_WX" property="nickNameRemarkWx" />
  </resultMap>
  
  <resultMap id="TodayManageShopNewResultMap" type="com.lj.business.member.dto.FindTodayManageShopReturn" >
    <result column="MEMBER_NO_GM" property="memberNoGm" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME_GM" property="memberNameGm" jdbcType="VARCHAR" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
    <result column="RATIO_WORK" property="ratioWork" jdbcType="DECIMAL" />
    <result column="MERCHANT_NO" property="merchantNo" jdbcType="VARCHAR" />
    
    
  </resultMap>
  
   <resultMap id="findPersonMemberReturn" type="com.lj.business.member.dto.FindPersonMemberReturnList" >
    <result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="AREA_CODE" property="areaCode" jdbcType="VARCHAR" />
    <result column="AREA_NAME" property="areaName" jdbcType="VARCHAR" />
    
    <!-- 客户分类 -->
    <result column="PM_TYPE_CODE" property="code" jdbcType="VARCHAR" />
    <result column="PM_TYPE_NAME" property="typeName" jdbcType="VARCHAR" />
  </resultMap>
  
  <resultMap type="com.lj.business.member.dto.FindImIndexPageReturn" id="findImIndexPageReturnMap">
  	<result column="CODE" property="code" jdbcType="VARCHAR" />
  	<result column="MERCHANT_NO" property="merchantNo" jdbcType="VARCHAR" />
  	<result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
  	<result column="MEMBER_NAME" property="memberName" jdbcType="VARCHAR" />
  	<result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
  	<result column="MEMBER_NO_GM" property="memberNoGm" jdbcType="VARCHAR" />
  	<result column="MEMBER_NAME_GM" property="memberNameGm" jdbcType="VARCHAR" />
  	
  	<result column="NICK_NAME_WX" property="nickNameWx" jdbcType="VARCHAR" />
  	<result column="ADD_TYPE" property="addType" jdbcType="VARCHAR" />
  	<result column="set_up_user" property="setUpUser" jdbcType="VARCHAR" />
  	<!-- 客户分类 -->
    <result column="PM_TYPE_CODE" property="pmTypeCode" jdbcType="VARCHAR" />
    <result column="PM_TYPE_NAME" property="pmTypeName" jdbcType="VARCHAR" />
  	
  	<result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
  	<result column="MOBILE" property="mobile" jdbcType="VARCHAR" />
  	<result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
  	<result column="NO_WX_ALIAS" property="noWxAlias" jdbcType="VARCHAR" />
  	<result column="NO_WX_GM" property="noWxGm" jdbcType="VARCHAR" />
  	<result column="chat_room_flag" property="chatRoomFlag" jdbcType="BIT" />
  	<result column="noDisturb" property="noDisturb" jdbcType="BIT" />
  	
  </resultMap>
  
  <resultMap id="FindPageByMemberNoAndShopNoMap" type="com.lj.business.member.dto.FindGmDistantPageReturn" >
   <id column="MEMBER_NO" property="memberNoGm" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME" property="memberNoGmName" jdbcType="VARCHAR" />
    
    
    <result column="MOBILE" property="mobile" jdbcType="VARCHAR" />
    <result column="QCORD" property="qcord" jdbcType="VARCHAR" />
    <result column="LOGO_ADDR" property="imgUrl" jdbcType="VARCHAR" />
    <result column="ADDR_INFO" property="address" jdbcType="VARCHAR" />
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
  </resultMap>
  
  <sql id="Base_Column_List" >
   CODE, MEMBER_NO, MEMBER_NAME, MEMBER_NO_GM, MEMBER_NAME_GM,  MERCHANT_NO, 
    MERCHANT_NAME, SPRUCE_UP, HOUSES, KEEP_EYE, URGENCY_PM, BOM_CODE, BOM_NAME, NICK_NAME_REMARK_WX, NICK_NAME_REMARK_LOCAL,
    CONTACT_DATE_LAST, BRAND_COMPARE, CLIENT_SPECIAL, CONSUME_FREQUENCY, SCAN_ADDRESS, LATITUDE, LONGITUDE, 
    FIRST_INTRODUCE, EXPECT_PURCHASE_TIME, EXP_TIME, WX_FRIENDS, ADD_TYPE, VERSION, CREATE_ID, CREATE_DATE, UPDATE_ID, UPDATE_DATE, REMARK4, REMARK3, 
    REMARK2, REMARK, PM_TYPE_CODE, PM_TYPE_NAME,SHOP_WX
  </sql>
  
  <!-- 客户信息关联查询  add by duanzhipeng at 2017-07-08  start -->
  <sql id="Join_Column_List" >
	<!--   	客户信息 -->
     pm.CODE, pm.MEMBER_NO, pm.MEMBER_NAME, pm.MEMBER_NO_GM, pm.MEMBER_NAME_GM,pm.MERCHANT_NO,pm.NICK_NAME_REMARK_WX,
    pm.MERCHANT_NAME, pm.SPRUCE_UP, pm.HOUSES, pm.KEEP_EYE, pm.URGENCY_PM, pm.BOM_CODE, pm.BOM_NAME, pm.CLIENT_SPECIAL,pm.CONSUME_FREQUENCY,pm.CONSUME_FREQUENCY,pm.ADD_TYPE,
    pm.CREATE_ID, pm.CREATE_DATE, pm.UPDATE_ID, pm.UPDATE_DATE, pm.REMARK4, pm.REMARK3, pm.REMARK2, pm.REMARK,pm.BRAND_COMPARE
    <!-- 		客户分类 -->
	,pm.PM_TYPE_CODE,pm.PM_TYPE_NAME
   <!-- 		客户基础信息 -->
    ,pmb.CODE BASE_CODE,pmb.STATUS, pmb.CERT_TYPE_CODE, pmb.CERT_NO, pmb.MOBILE,pmb.IMEI,
	pmb.EMAIL, pmb.JOB,pmb.ADDRESS, pmb.AGE, pmb.SEX, pmb.NAME_AUTH_FLAG, pmb.PWD, pmb.ENCRYPTION_CODE, pmb.MEMBER_SRC,
	pmb.OPEN_ID_GZH_WX,pmb.OPEN_ID_XCX_WX, pmb.NICK_NAME_WX, pmb.CITY_WX, pmb.COUNTRY_WX, pmb.PROVINCE_WX, pmb.HEAD_ADDRESS,
	pmb.SUBSRIBE_TIME,pmb.FAMILY_CODE, pmb.FAMILY_NAME, pmb.INTEREST,pmb.CONSTELLATION, pmb.AREA_CODE,pmb.PROVINCE_CODE,pmb.CITY_CODE,pmb.CITY_AREA_CODE,
	pmb.NO_WX,pmb.NO_WX_ALIAS,pmb.BIRTHDAY,pmb.WX_OPENID
	<!-- 		导购信息 -->
	,(SELECT st.HEAD_URL from shop_terminal st WHERE st.NO_WX = pm.SHOP_WX) GMPHOTO
  </sql>
  
  <sql id="Join_Column_List_noinvite" >
	pm.MERCHANT_NO,pm.MEMBER_NAME,pm.MEMBER_NAME_GM,pm.MEMBER_NO_GM,pm.MEMBER_NO,pm.CODE,pm.ADD_TYPE,pmb.CODE BASE_CODE
  	,pmb.NO_WX,pmb.NO_WW ,pmb.HEAD_ADDRESS,pmb.NO_WX_ALIAS,pmb.NICK_NAME_WX,pmb.WX_OPENID
  	,pmb.MOBILE,pmb.SEX,pmb.PROVINCE_CODE,pmb.CITY_AREA_CODE,pmb.CITY_CODE,pm.BOM_NAME,pm.HOUSES,pmb.MEMBER_SRC,pm.CREATE_DATE
	,pm.SHOP_WX
	<!-- 		客户分类 -->
	,pm.PM_TYPE_CODE,pm.PM_TYPE_NAME
	<!-- 		客户分类表 -->
	,pt.PM_TYPE_TYPE,pt.PM_TYPE_DIM,pt.STATUS as PM_TYPE_STATUS
  </sql>
  
   <!-- 客户信息关联查询  add by duanzhipeng at 2017-07-08  end -->
  
  <!-- 客户信息关联查询  add by duanzhipeng at 2017-07-08  start -->
  <sql id="findPersonMemberPage_condition" >
  	 <where>
      <if test="memberNo != null  and memberNo !=''" >
        and  pm.MEMBER_NO = #{memberNo}
      </if>
        <if test="memberNameGm != null  and memberNameGm !=''" >
        and  pm.MEMBER_NAME_GM like CONCAT('%',#{memberNameGm,jdbcType=VARCHAR},'%' )
      </if>
      <if test="memberName != null and memberName !='' ">
		and (pm.MEMBER_NAME like CONCAT('%',#{memberName,jdbcType=VARCHAR},'%' ) 
		or pm.NICK_NAME_REMARK_WX like CONCAT('%',#{memberName,jdbcType=VARCHAR},'%'))
	  </if>
	  <if test="startTime != null">
		<![CDATA[and pm.CREATE_DATE >= #{startTime}]]>
		</if>
		<if test="endTime != null"> 
			<![CDATA[and pm.CREATE_DATE <= #{endTime}]]>
		</if>
	  	<if test="memberNoGm != null and memberNoGm !='' ">
			and pm.MEMBER_NO_GM = #{memberNoGm}
		</if>
		<if test="merchantNo != null and merchantNo !='' ">
			and pm.MERCHANT_NO = #{merchantNo}
		</if>
		<if test="noWx == '-1'">
			and pmb.NO_WX != '' and NOT ISNULL(pmb.NO_WX)
		</if>
		
		<choose>
            <!-- FixBug:1120 客户列表搜索所属终端，需要精准搜索
            <when test="shopWxs != null and shopWxs.length > 0">
                and pm.SHOP_WX in <foreach item="item" index="index" collection="shopWxs" open="(" separator="," close=")">#{item}</foreach>
            </when>
            <otherwise>
               <if test="shopWx != null and shopWx != ''">
					and pm.SHOP_WX like CONCAT('%',#{shopWx,jdbcType=VARCHAR},'%') 
				</if>
            </otherwise> -->
            <when test="shopWx != null and shopWx != ''">
            	and pm.SHOP_WX = #{shopWx,jdbcType=VARCHAR}
            </when>
            <otherwise>
            	<if test="shopWxs != null and shopWxs.length > 0">
            		and pm.SHOP_WX in <foreach item="item" index="index" collection="shopWxs" open="(" separator="," close=")">#{item}</foreach>
            	</if>
            </otherwise>
        </choose>
      
		<!-- 	  客户基础条件 -->
	      <if test="imei != null and imei !='' ">
			and pmb.IMEI = #{imei}
		</if>
		<if test="mobile != null and mobile !='' ">
		  and pmb.MOBILE like CONCAT('%',#{mobile,jdbcType=VARCHAR},'%' )
		</if>
		<if test="noWw != null and noWw !='' ">
		  and pmb.NO_WW like CONCAT('%',#{noWw,jdbcType=VARCHAR},'%' )
		</if>
		<if test="noWx != null and noWx !='' ">
		  and pmb.NO_WX_ALIAS like CONCAT('%',#{noWx,jdbcType=VARCHAR},'%' )
		</if>
		<if test="memberSrc != null and memberSrc !='' "><!--前端传 WITHOUT代表无来源 -->
			<if test='memberSrc == "WITHOUT"'>
				and pmb.MEMBER_SRC is null
			</if>
			<if test='memberSrc != "WITHOUT"'>
				and pmb.MEMBER_SRC = #{memberSrc}
			</if>
		</if>
		<if test="province != null and province !='' ">
			and pmb.PROVINCE_CODE = #{province}
		</if>
		<if test="city != null and city !='' ">
			and pmb.CITY_CODE = #{city}
		</if>
		<if test="region != null and region !='' ">
			and pmb.CITY_AREA_CODE = #{region}
		</if>
		<if test="area != null and area !='' ">
			and (pmb.PROVINCE_WX like CONCAT('%',#{area},'%') OR pmb.CITY_WX like CONCAT('%',#{area},'%'))
		</if>
	    <if test="memberSrcNull != null and  memberSrcNull !='' ">
			and pmb.MEMBER_SRC is null
		</if>
		<if test="updateDate != null ">
			<![CDATA[and pm.UPDATE_DATE >= #{updateDate}]]>
		</if>
		
		<!-- DZP 客户类型条件 -->
		<if test="pmTypeType != null and pmTypeType !='' ">
			and pt.PM_TYPE_TYPE = #{pmTypeType}
		</if>
		<if test="pmTypeCode != null and pmTypeCode !=''">
			and pm.PM_TYPE_CODE = #{pmTypeCode}
		</if>
		<if test="pmTypeDim != null and pmTypeDim !='' ">
			and pt.PM_TYPE_DIM = #{pmTypeDim}
		</if>
		
		<if test="keyWord != null and keyWord != ''">
			and (pmb.MOBILE like '%${keyWord}%' or
			pm.MEMBER_NAME like '%${keyWord}%' or
			pmb.NICK_NAME_WX like '%${keyWord}%' or
			pm.NICK_NAME_REMARK_LOCAL like '%${keyWord}%')
		</if>
		
     </where>
  </sql>
  <!-- 客户信息关联查询条件  add by duanzhipeng at 2017-07-08  end -->
   <sql id="findPersonMemberSex">
   <where>
    <if test="merchantNo != null and merchantNo !='' ">
		and pm.MERCHANT_NO = #{merchantNo}
	</if>
	  <if test="areaCode != null and areaCode !='' ">
		and  pmb.AREA_CODE = #{areaCode}
	  </if>
   </where>
   </sql>
   
  <sql id="findPmTypeIndexPage_condition" >
	WHERE pmb.MEMBER_NO = pm.MEMBER_NO
     AND bp.MEMBER_NO = pm.MEMBER_NO
	 AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
	     <if test="memberNoGm != null and memberNoGm != ''" >
	      	AND pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
	      </if>
      AND pm.PM_TYPE_CODE = #{pmTypeCode,jdbcType=VARCHAR}
  </sql>
  
  <sql id="findPmTypeIndexPageWithLabel_condition" >
	WHERE pmb.MEMBER_NO = pm.MEMBER_NO
     AND bp.MEMBER_NO = pm.MEMBER_NO
     AND pmb.MEMBER_NO = plp.MEMBER_NO
     AND pl.CODE = plp.PM_LABEL_CODE
	 AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
	 AND pl.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
     <if test="memberNoGm != null and memberNoGm != ''" >
     	AND pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
     </if>
     AND pm.PM_TYPE_CODE = #{pmTypeCode,jdbcType=VARCHAR}
  </sql>
  
  <sql id="findPmSeachPage_condition" >
	  WHERE pmb.MEMBER_NO = pm.MEMBER_NO
     		AND bp.MEMBER_NO = pm.MEMBER_NO
	       	AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
	       	<if test="memberNoGm != null and memberNoGm != ''" >
      	 		AND pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
      	 	</if>
      	 	<if test="memberNoList != null" >
	       		AND pm.MEMBER_NO in (
               <foreach item="memberNoArItem" index="index" collection="memberNoList" separator=","> 
               	#{memberNoArItem} 
               </foreach>
               )
	      	</if>
	      	<if test="searchKey != null and searchKey != ''" >
		       and (pm.MEMBER_NAME like CONCAT('%',#{searchKey,jdbcType=VARCHAR},'%') 
		       or pmb.MOBILE like CONCAT('%',#{searchKey,jdbcType=VARCHAR},'%')
		       or pmb.NICK_NAME_WX like CONCAT('%', #{searchKey,jdbcType=VARCHAR},'%')
		       )
	      	</if>
  </sql>
  
  <sql id="findPmSeachPageHc_condition" >
	  WHERE pmb.MEMBER_NO = pm.MEMBER_NO
     		AND bp.MEMBER_NO = pm.MEMBER_NO
	       	AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
	       	<if test="memberNoGm != null and memberNoGm != ''" >
      	 		AND pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
      	 	</if>
      	 	<if test="memberNoList != null" >
	       		AND pm.MEMBER_NO in (
               <foreach item="memberNoArItem" index="index" collection="memberNoList" separator=","> 
               	#{memberNoArItem} 
               </foreach>
               )
	      	</if>
		      <if test="searchKey != null and searchKey != ''" >
		       and (pm.MEMBER_NAME like CONCAT('%',#{searchKey,jdbcType=VARCHAR},'%') 
		       or pmb.NICK_NAME_WX like CONCAT('%', #{searchKey,jdbcType=VARCHAR},'%')
		       )
		      </if>
  </sql>
  
  <sql id="findUrgentMbrPage_condition" >
	WHERE pmb.MEMBER_NO = pm.MEMBER_NO
   AND bp.MEMBER_NO = pm.MEMBER_NO
	       AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
	     <if test="memberNoGm != null and memberNoGm != ''" >
      	 AND pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
      	 </if>
	       AND pm.URGENCY_PM = 'Y'
  </sql>
  
  <sql id="findNewPmPage_condition" >
	WHERE     pm.MEMBER_NO = pmb.MEMBER_NO
       AND pt.CODE = pm.PM_TYPE_CODE
       AND pt.PM_TYPE_TYPE IN ('SUCCESS',
                               'GIVE_UP',
                               'INTENTION',
                               'UNGROUP',
                               'INTENTION_N',
                               'OTHER')
       AND pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
       AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
       AND pm.CREATE_DATE >= CURDATE()
  </sql>
  
  <sql id="findPersonMemberTypeNums">
  <where>
  	 <if test="merchantNo != null and merchantNo !='' ">
			and pm.MERCHANT_NO = #{merchantNo}
    </if>
      <if test="areaCode != null and areaCode !='' ">
		  and  pmb.AREA_CODE = #{areaCode}
    </if>
     <if test="memberNoGm!= null and memberNoGm !='' ">
		  and  pm.MEMBER_NO_GM = #{memberNoGm}
    </if>
     <if test="pmTypeCode!= null and pmTypeCode !='' ">
		  and  pt.CODE = #{pmTypeCode}
    </if>
  </where>
  </sql>
  
  <select id="findPersonMemberCont" resultType="int" parameterType="com.lj.business.member.dto.FindPersonMember">
   SELECT COUNT(DISTINCT pm.MEMBER_NO) 
   FROM  person_member pm LEFT JOIN person_member_base pmb ON pm.MEMBER_NO=pmb.MEMBER_NO
   WHERE 1=1
    <if test="merchantNo != null and merchantNo !='' ">
	 and  pm.MERCHANT_NO = #{merchantNo}
    </if>
      <if test="areaCode != null and areaCode !='' ">
	 and  pmb.AREA_CODE = #{areaCode}
    </if>
      <if test="provinceCode != null and provinceCode !='' ">
	 and  pmb.PROVINCE_CODE = #{provinceCode}
    </if>
 </select>
 
  <select id="queryPersonMemberPmType" resultType="com.lj.business.member.dto.FindPersonMemberReturnList" parameterType="com.lj.business.member.dto.FindPersonMember">
   SELECT  pt.PM_TYPE_TYPE pmTypeType,pm.PM_TYPE_NAME typeName,pm.PM_TYPE_CODE code FROM  person_member pm 
    LEFT JOIN pm_type pt ON pm.PM_TYPE_CODE=pt.CODE
   WHERE pm.MEMBER_NO=#{memberNo} 
    AND  pm.MEMBER_NO_GM=#{memberNoGm}  
    LIMIT 1
 </select>
 
 <select id="queryPersonMemberPmTypeExceptRepeatAndUrgency" resultType="com.lj.business.member.dto.FindPersonMemberReturnList" parameterType="com.lj.business.member.dto.FindPersonMember">
   SELECT  pt.PM_TYPE_TYPE pmTypeType,pm.PM_TYPE_NAME typeName,pm.PM_TYPE_CODE code FROM  person_member pm 
    LEFT JOIN pm_type pt ON pm.PM_TYPE_CODE=pt.CODE
   WHERE pm.MEMBER_NO=#{memberNo} 
    AND  pm.MEMBER_NO_GM=#{memberNoGm}  
    AND  pt.PM_TYPE_TYPE not in ('URGENCY', 'REPEAT')
    LIMIT 1
 </select>
 
 <select id="findShopPmNum" resultType="map">
 	SELECT SHOP_NO shopNo,SHOP_NAME shopName,COUNT(*) numPm
	FROM  PERSON_MEMBER
	<where>
		<if test="merchantCode != null and merchantCode != ''">
			and MERCHANT_NO = #{merchantCode}
		</if>
		<if test="beginTime != null" >
            <![CDATA[
              and CREATE_DATE >= #{beginTime}
            ]]>
        </if>
        <if test="endTime != null" >
            <![CDATA[
              and CREATE_DATE <= #{endTime}
            ]]>
        </if>
	</where>
	group by  SHOP_NAME
 </select>
  
  <select id="findCountAddIntention" resultType="map">
  	select pm.SHOP_NO shopNo,pm.SHOP_NAME shopName,count(*) numPmIntention
	from member.PERSON_MEMBER pm,
	member.PM_TYPE pt
    where pt.CODE = pm.PM_TYPE_CODE 
    and  pt.PM_TYPE_TYPE in ('INTENTION','INTENTION_N')
    <if test="merchantCode != null and merchantCode != ''">
		and pm.MERCHANT_NO = #{merchantCode}
	</if>
	<if test="beginTime != null" >
        <![CDATA[
          and pm.CREATE_DATE >= #{beginTime}
        ]]>
    </if>
    <if test="endTime != null" >
        <![CDATA[
          and pm.CREATE_DATE <= #{endTime}
        ]]>
    </if>
	group by pm.SHOP_NO
  </select>
  
  <select id="findCountAddOther" resultType="map">
  	select pm.SHOP_NO shopNo,pm.SHOP_NAME shopName,count(*) numPmNoIntention
	from member.PERSON_MEMBER pm,
	member.PM_TYPE pt
	where pt.CODE = pm.PM_TYPE_CODE 
	and  pt.PM_TYPE_TYPE in ('OTHER')
	<if test="merchantCode != null and merchantCode != ''">
		and pm.MERCHANT_NO = #{merchantCode}
	</if>
	<if test="beginTime != null" >
        <![CDATA[
          and pm.CREATE_DATE >= #{beginTime}
        ]]>
    </if>
    <if test="endTime != null" >
        <![CDATA[
          and pm.CREATE_DATE <= #{endTime}
        ]]>
    </if>
	group by pm.SHOP_NO
  </select>
  
  <select id="findCountPmOrder" resultType="map">
  	select pm.SHOP_NO shopNo,pm.SHOP_NAME shopName,count(*) numOrderPm
	from member.PERSON_MEMBER pm,
	member.PM_TYPE pt
	where pt.CODE = pm.PM_TYPE_CODE 
	and  pt.PM_TYPE_TYPE in ('SUCCESS')
	<if test="merchantCode != null and merchantCode != ''">
		and pm.MERCHANT_NO = #{merchantCode}
	</if>
	<if test="beginTime != null" >
        <![CDATA[
          and pm.CREATE_DATE >= #{beginTime}
        ]]>
    </if>
    <if test="endTime != null" >
        <![CDATA[
          and pm.CREATE_DATE <= #{endTime}
        ]]>
    </if>
	group by pm.SHOP_NO
  </select>
  
  <select id="finCountAddPmAbandon" resultType="map">
  	select pm.SHOP_NO shopNo,pm.SHOP_NAME shopName,count(*) numPmAbandon
	from member.PERSON_MEMBER pm,
	member.PM_TYPE pt
	where pt.CODE = pm.PM_TYPE_CODE 
	and  pt.PM_TYPE_TYPE in ('GIVE_UP')
	<if test="merchantCode != null and merchantCode != ''">
		and pm.MERCHANT_NO = #{merchantCode}
	</if>
	<if test="beginTime != null" >
        <![CDATA[
          and pm.CREATE_DATE >= #{beginTime}
        ]]>
    </if>
    <if test="endTime != null" >
        <![CDATA[
          and pm.CREATE_DATE <= #{endTime}
        ]]>
    </if>
	group by pm.SHOP_NO
  </select>
  
  <select id="findcountAddPmUngroup" resultType="map">
  	select pm.SHOP_NO shopNo,pm.SHOP_NAME shopName,count(*) numPmUngroup
	from member.PERSON_MEMBER pm,
	member.PM_TYPE pt
	where pt.CODE = pm.PM_TYPE_CODE 
	and  pt.PM_TYPE_TYPE in ('UNGROUP')
	<if test="merchantCode != null and merchantCode != ''">
		and pm.MERCHANT_NO = #{merchantCode}
	</if>
	<if test="beginTime != null" >
        <![CDATA[
          and pm.CREATE_DATE >= #{beginTime}
        ]]>
    </if>
    <if test="endTime != null" >
        <![CDATA[
          and pm.CREATE_DATE <= #{endTime}
        ]]>
    </if>
	group by pm.SHOP_NO
  </select>
  
   <!-- 统计报表客户分组数量统计-->
  <select id="findPersonMemberTypeNum" resultMap="findPersonMemberReturn" parameterType="com.lj.business.member.dto.FindPersonMember">
    SELECT COUNT(pm.MEMBER_NO)AS MEMBER_NO,pt.PM_TYPE_TYPE,pmb.AREA_CODE,pmb.AREA_NAME
    FROM person_member  pm
    LEFT JOIN pm_type pt ON pt.CODE= pm.PM_TYPE_CODE
    LEFT JOIN person_member_base pmb ON pmb.MEMBER_NO=pm.MEMBER_NO
    <include refid="findPersonMemberTypeNums"/>
    GROUP BY pt.PM_TYPE_TYPE
    ORDER BY COUNT(pm.MEMBER_NO) DESC
    LIMIT 1
  </select>
  <!-- 统计客户分组列表 -->
  <select id="findPersonMemberTypeList" resultType="com.lj.business.member.dto.FindPersonMemberReturnList" parameterType="com.lj.business.member.dto.FindPersonMember">
  SELECT pm.SHOP_NO shopNo,pm.SHOP_NAME shopName,pm.MEMBER_NO_GM  memberNoGm,pm.MEMBER_NAME_GM memberNameGm,pmb.AREA_CODE areaCode,
  pmb.AREA_NAME areaName,COUNT(pm.MEMBER_NO)AS count,pt.PM_TYPE_TYPE pmTypeType,pm.MERCHANT_NO merchantNo,pt.CODE code,pt.TYPE_NAME typeName
  FROM person_member pm
  LEFT JOIN person_member_base pmb on pm.MEMBER_NO=pmb.MEMBER_NO
  LEFT JOIN pm_type pt ON pt.CODE= pm.PM_TYPE_CODE
  <include refid="findPersonMemberTypeNums"/>
  </select>
  
    <select id="findPersonMemberType" resultType="com.lj.business.member.dto.FindPersonMemberReturnList" parameterType="com.lj.business.member.dto.FindPersonMember">
  SELECT pm.SHOP_NO shopNo,pm.SHOP_NAME shopName,pm.MEMBER_NO_GM  memberNoGm,pm.MEMBER_NAME_GM memberNameGm,pmb.AREA_CODE areaCode,
  pmb.AREA_NAME areaName,COUNT(pm.MEMBER_NO)AS count,pt.PM_TYPE_TYPE pmTypeType,pm.MERCHANT_NO merchantNo,pt.CODE code,pt.TYPE_NAME typeName
  FROM person_member pm
  LEFT JOIN person_member_base pmb on pm.MEMBER_NO=pmb.MEMBER_NO
  LEFT JOIN pm_type pt ON pt.CODE= pm.PM_TYPE_CODE
  <include refid="findPersonMemberTypeNums"/>
  GROUP BY pt.PM_TYPE_TYPE
  </select>
  
  
  <select id="findPersonMemberTypeCount"  resultType="int" parameterType="com.lj.business.member.dto.FindPersonMember">
  SELECT count(pm.MEMBER_NO)
  FROM person_member pm
  LEFT JOIN person_member_base pmb on pm.MEMBER_NO=pmb.MEMBER_NO
  LEFT JOIN pm_type pt ON pt.CODE= pm.PM_TYPE_CODE
  <include refid="findPersonMemberTypeNums"/>
  <if test="createDate!= null and createDate !='' ">
	and  date_format(pm.CREATE_DATE,'%Y-%m-%d') = date_format(#{createDate},'%Y-%m-%d')
  </if>
  <if test="pmTypeType != null and pmTypeType != ''">
  	and pt.PM_TYPE_TYPE = #{pmTypeType}
  </if>
  </select>
  
   <!-- 根据导购查询客户-->
  <select id="findPersonMemberByGm" resultMap="findListResultMap" parameterType="com.lj.business.member.dto.FindPersonMember">
	select 
    <include refid="Base_Column_List"/>
    from person_member pm
    <where>
	    <if test="merchantNo != null and merchantNo !='' ">
				and pm.MERCHANT_NO = #{merchantNo}
	    </if>
	    <if test="memberNoGm != null and memberNoGm !='' ">
				and pm.MEMBER_NO_GM = #{memberNoGm}
	    </if>
	    <if test="memberNo !=null and memberNo!='' ">
	            and pm.MEMBER_NO = #{memberNo}
	    </if>
	    <if test="memberNoList != null" >
		       AND pm.MEMBER_NO in (
	             <foreach item="memberNoArItem" index="index" collection="memberNoList" separator=","> 
	             	#{memberNoArItem} 
	             </foreach>
	             )
	     </if>
	     <if test="shopWx !=null and shopWx !='' ">
            and pm.SHOP_WX = #{shopWx}
    </if>
     </where>
  </select>
  
    <select id="findPersonMemberByNoWx" resultType="com.lj.business.member.dto.FindPersonMemberReturn" parameterType="com.lj.business.member.dto.FindPersonMember">
	select MEMBER_NO memberNo
    from person_member
    WHERE 
	 MEMBER_NO_GM = #{memberNoGm}
	 and  ADD_TYPE !='3'
   </select>
   
   <!-- 查找web客户信息(导购助手) begin -->
   <sql id="findImIndexSql">	<!-- 客户信息查询SQL -->
   		<where>
   				pmb.no_wx is not null	and pm.WX_FRIENDS = 1
   				<if test="startTime != null">
					<![CDATA[and pm.CREATE_DATE >= #{startTime}]]>
				</if>
				<if test="endTime != null"> 
					<![CDATA[and pm.CREATE_DATE <= #{endTime}]]>
				</if>
				<if test="noWx != null and noWx != ''">
					and pm.SHOP_WX = #{noWx}
				</if>
				<if test="setUpUser != null and setUpUser != ''">
					and pmb.set_up_user = #{setUpUser}
				</if>
				<if test="noWxList != null">
			       	and pm.SHOP_WX in <foreach item="item" index="index" collection="noWxList" open="(" separator="," close=")">#{item}</foreach>
			    </if>
				<if test="typeCode != null and typeCode != ''">
					<choose>
						<when test="typeCode == 'TODAY'">
							AND DATE(pm.CREATE_DATE)=DATE(NOW())
						</when>
						<when test="typeCode == 'WEEK'">
							AND <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= DATE(pm.CREATE_DATE) ]]>
						</when>
						<when test="typeCode == 'MONTH'">
							AND <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= DATE(pm.CREATE_DATE) ]]>
						</when>
						<otherwise>
							AND pm.PM_TYPE_CODE = #{typeCode} 
						</otherwise>
					</choose>
				</if>
				<if test="memberNoGm != null and memberNoGm != ''">
					AND pm.MEMBER_NO_GM = #{memberNoGm}
				</if>
				<if test="keyWord != null and keyWord != ''">
					AND (pm.MEMBER_NAME LIKE CONCAT('%',#{keyWord}, '%') OR pmb.MOBILE LIKE CONCAT('%',#{keyWord}, '%')
						OR pmb.NICK_NAME_WX LIKE CONCAT('%',#{keyWord}, '%'))
				</if>
   		</where>
   </sql>
   <sql id="findImIndexSqlByChatRoom">	<!-- 群聊查询SQL -->
   	WHERE cr.status = 1
	<if test="startTime != null">
		<![CDATA[and cr.CREATE_DATE >= #{startTime}]]>
	</if>
	<if test="endTime != null"> 
		<![CDATA[and cr.CREATE_DATE <= #{endTime}]]>
	</if>
	<if test="noWx != null and noWx != ''">
		and cr.NO_WX_ZK = #{noWx}
	</if>
	<if test="memberNoGm != null and memberNoGm != ''">
		and cr.MEMBER_NO_GM = #{memberNoGm}
	</if>
	<if test="setUpUser != null and setUpUser != ''">
		and cr.set_up_user = #{setUpUser}
	</if>
	<if test="noWxList != null">
       	and cr.NO_WX_ZK in
       <foreach item="item" index="index" collection="noWxList" open="(" separator="," close=")">  
         #{item}  
       </foreach>
    </if>
	<if test="keyWord != null and keyWord != ''">
		AND cr.ROOM_NICK_NAME LIKE CONCAT('%',#{keyWord}, '%')
	</if>
   </sql>
   <select id="findImIndexList" parameterType="com.lj.business.member.dto.FindImIndexPage" resultMap="findImIndexPageReturnMap">
	   	SELECT * FROM (
	   	SELECT pm.code, pm.merchant_no, pm.member_no_gm, pm.member_name_gm,
			   pmb.member_no, 
			   IF(ISNULL(pm.NICK_NAME_REMARK_WX)||pm.NICK_NAME_REMARK_WX='',pm.MEMBER_NAME,pm.NICK_NAME_REMARK_WX) member_name, 
			   pmb.nick_name_wx, pcb.CHAT_TIME create_date, pmb.head_address,
			   pm.add_type, pm.PM_TYPE_CODE ,pmb.MOBILE, pmb.NO_WX, pmb.NO_WX_ALIAS, 
			   pmb.set_up_user,
			   pm.SHOP_WX NO_WX_GM, 
			   pcb.THIRD_UNREAD_FLAG, pcb.CHAT_TIME, 0 chat_room_flag,0 noDisturb
		  FROM 
		  person_member pm 
		  JOIN person_member_base pmb ON pm.member_no = pmb.member_no 
		  left join PM_CHAT_BEHAVIOR pcb on pm.member_no = pcb.member_no and pm.SHOP_WX = pcb.NO_WX_GM
		  <include refid="findImIndexSql"/>
		<if test="queryChatRoom == null or queryChatRoom == 'true'">	<!-- 查询群聊信息 -->
			UNION ALL
			select code, merchant_no, cr.member_no_gm, '' member_name_gm, 
			       code member_no, ROOM_NICK_NAME member_name, ROOM_NICK_NAME nick_name_wx,pcb.CHAT_TIME create_date, HEAD_URL head_address,
			       4 add_type, 'CHATROOM' PM_TYPE_CODE, '' MOBILE, CHAT_ROOM_NAME NO_WX, CHAT_ROOM_NAME NO_WX_ALIAS,
			       cr.set_up_user, NO_WX_ZK NO_WX_GM,
				   pcb.THIRD_UNREAD_FLAG, pcb.CHAT_TIME, 1 chat_room_flag,cr.NO_DISTURB noDisturb
			  from chat_room cr
			  left join PM_CHAT_BEHAVIOR pcb on cr.code = pcb.member_no and cr.NO_WX_ZK = pcb.NO_WX_GM
			  <include refid="findImIndexSqlByChatRoom"/>
		</if>
		) t
		order by t.set_up_user desc,t.CHAT_TIME desc,t.THIRD_UNREAD_FLAG desc, t.CREATE_DATE ${sortDir}
		limit ${start} , ${limit}
   </select>
   <select id="findImIndexListCount" parameterType="com.lj.business.member.dto.FindImIndexPage" resultType="long">
   		select sum(cc) 
   		  from (
		   	SELECT COUNT(1) cc
			  FROM 
			  person_member pm 
			  JOIN person_member_base pmb ON pm.member_no = pmb.member_no 
			  left join PM_CHAT_BEHAVIOR pcb on pm.member_no = pcb.member_no and pm.member_no_gm = pcb.NO_WX_GM
			  <include refid="findImIndexSql"/>
		<if test="queryChatRoom == null or queryChatRoom == 'true'">	<!-- 查询群聊信息 -->
			UNION ALL
			select COUNT(1) cc
			  from chat_room cr
			  left join PM_CHAT_BEHAVIOR pcb on cr.code = pcb.member_no and cr.NO_WX_ZK = pcb.NO_WX_GM
			  <include refid="findImIndexSqlByChatRoom"/>
		</if>
		) c
   </select>
   <!-- 查找web客户信息(导购助手) end -->
   
   <!-- 预报名 begin -->
   <select id="findForecastNameIndexList" resultMap="findImIndexPageReturnMap">
   	SELECT pm.code, gm.merchant_no, pm.member_no_gm, gm.member_name member_name_gm, gm.
	pmb.member_no, pm.member_name, pmb.nick_name_wx, pm.create_date, pmb.head_address,
	pm.add_type, pm.PM_TYPE_CODE ,pmb.MOBILE
	FROM guid_member gm 
	JOIN person_member pm ON gm.member_no = pm.member_no_gm
	JOIN person_member_base pmb ON pm.member_no = pmb.member_no 
	left join PM_CHAT_BEHAVIOR pcb on pm.member_no = pcb.member_no and pm.member_no_gm = pcb.NO_WX_GM
	<include refid="findForecastNameIndexSql"/>
	order by pcb.THIRD_UNREAD_FLAG desc, pcb.CHAT_TIME desc, pm.CREATE_DATE ${sortDir}
	limit ${start} , ${limit}
   </select>
   
   <select id="findForecastNameIndexListCount" resultType="long">
   	SELECT COUNT(1)
	FROM guid_member gm JOIN person_member pm ON gm.member_no = pm.member_no_gm
	JOIN person_member_base pmb ON pm.member_no = pmb.member_no 
	left join PM_CHAT_BEHAVIOR pcb on pm.member_no = pcb.member_no and pm.member_no_gm = pcb.NO_WX_GM
	<include refid="findForecastNameIndexSql"/>
   </select>
   
   <sql id="findForecastNameIndexSql">
   	WHERE pmb.no_wx is not null
		and pm.WX_FRIENDS = 1
		and pm.code in (
		select distinct MEMBER_CODE 
		from forecast_name f, guid_member gm 
		where f.MEMBER_NO_GM = gm.MEMBER_NO and gm.NO_WX = #{noWx})
	<if test="noWx != null and noWx != ''">
		and gm.no_wx = #{noWx}
	</if>
	<if test="noWxList != null">
       	and gm.NO_WX in
       <foreach item="item" index="index" collection="noWxList" open="(" separator="," close=")">  
         #{item}  
       </foreach>
    </if>
	<if test="repeatCode != null and repeatCode != ''">
		AND pm.PM_TYPE_CODE != #{repeatCode}
	</if>
	<if test="urgencyCode != null and urgencyCode != ''">
		AND pm.PM_TYPE_CODE != #{urgencyCode}
	</if>
	<if test="typeCode != null and typeCode != ''">
		<choose>
			<when test="typeCode == 'TODAY'">
			AND DATE(pm.CREATE_DATE)=DATE(NOW())
			</when>
			<when test="typeCode == 'WEEK'">
			AND <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= DATE(pm.CREATE_DATE) ]]>
			</when>
			<when test="typeCode == 'MONTH'">
			AND <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= DATE(pm.CREATE_DATE) ]]>
			</when>
			<otherwise>
			AND pm.PM_TYPE_CODE = #{typeCode} 
			</otherwise>
		</choose>
	</if>
	<if test="memberNo != null and memberNo != ''">
		AND gm.MEMBER_NO = #{memberNo}
	</if>
	<if test="keyWord != null and keyWord != ''">
		AND (pm.MEMBER_NAME LIKE CONCAT('%',#{keyWord}, '%') OR pmb.MOBILE LIKE CONCAT('%',#{keyWord}, '%')
			OR pmb.NICK_NAME_WX LIKE CONCAT('%',#{keyWord}, '%'))
	</if>
   </sql>
   <!-- 预报名 end -->
   
   <!-- 群发优惠券，客户列表分页查询 begin -->
   <sql id="findPmListByShopTerminalsSql">
   	WHERE pmb.no_wx is not null
		and pm.WX_FRIENDS = 1
	<if test="noWx != null and noWx !=''">
       	and pm.SHOP_WX = #{noWx} 
    </if>
	<if test="typeCode != null and typeCode != ''">
		<choose>
			<when test="typeCode == 'TODAY'">
			AND DATE(pm.CREATE_DATE)=DATE(NOW())
			</when>
			<when test="typeCode == 'WEEK'">
			AND <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= DATE(pm.CREATE_DATE) ]]>
			</when>
			<when test="typeCode == 'MONTH'">
			AND <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= DATE(pm.CREATE_DATE) ]]>
			</when>
			<otherwise>
			AND pm.PM_TYPE_CODE = #{typeCode} 
			</otherwise>
		</choose>
	</if>
	<if test="keyWord != null and keyWord != ''">
		AND (pm.MEMBER_NAME LIKE CONCAT('%',#{keyWord}, '%') 
				OR pmb.NO_WX LIKE CONCAT('%',#{keyWord}, '%')
				OR pmb.NO_WX_ALIAS LIKE CONCAT('%',#{keyWord}, '%') 
				OR pmb.NICK_NAME_WX LIKE CONCAT('%',#{keyWord}, '%')
			 	OR pm.NICK_NAME_REMARK_WX LIKE CONCAT('%',#{keyWord}, '%')
			 )
	</if>
	<if test="sex != null and sex != ''">
		AND pmb.SEX = #{sex}
	</if>
   </sql>
   
   <select id="findPmListByShopTerminals" resultMap="findImIndexPageReturnMap" parameterType="com.lj.business.member.dto.FindImIndexPage" >
   	SELECT pm.code, pm.merchant_no, pm.member_no_gm, pm.SHOP_WX NO_WX_GM,
   	pm.member_no,pm.member_name, pmb.nick_name_wx, pm.create_date, pmb.head_address,
	pm.add_type, pm.PM_TYPE_CODE ,pmb.MOBILE, pmb.NO_WX, pmb.NO_WX_ALIAS,
	pm.PM_TYPE_NAME pmTypeName
	FROM person_member pm 
	JOIN person_member_base pmb ON pm.member_no = pmb.member_no 
	<include refid="findPmListByShopTerminalsSql"/>
	order by pm.CREATE_DATE ${sortDir}
	limit ${start} , ${limit}
   </select>
   
   <select id="findPmListByShopTerminalsCount" resultType="long" parameterType="com.lj.business.member.dto.FindImIndexPage" >
   	SELECT COUNT(1)
	FROM person_member pm 
	JOIN person_member_base pmb ON pm.member_no = pmb.member_no 
	<include refid="findPmListByShopTerminalsSql"/>
   </select>
   <!-- 群发优惠券，客户列表分页查询 end -->
  
   <!-- 新增客户,分页查询 -->
   <select id="findNewPmPage" resultMap="findNewPmPageResultMap" parameterType="com.lj.business.member.dto.FindPmTypeIndexPage" >
 SELECT pm.MEMBER_NO,
       pm.MEMBER_NAME,
       pmb.MOBILE,
       pmb.NO_WX,
       pmb.NICK_NAME_WX,
       pm.NICK_NAME_REMARK_WX,
       pm.NICK_NAME_REMARK_LOCAL,
       pmb.HEAD_ADDRESS,
       pm.CREATE_DATE,
       '客户资料完成' AS REMARK_COM,
       IF(pt.PM_TYPE_TYPE = 'UNGROUP', 'Y', 'N') AS UNGROUP,
       IF(pmb.MEMBER_NAME is NOT NULL AND pmb.NO_WX IS NOT NULL AND pmb.MEMBER_SRC IS NOT NULL AND pmb.MOBILE IS NOT NULL, 'Y', 'N' ) AS COMPLETE,
       pmb.RATIO_CLIENT_INFO,
       pm.FIRST_INTRODUCE
  FROM PERSON_MEMBER pm,
       PERSON_MEMBER_BASE pmb,
       PM_TYPE pt
	 <include refid="findNewPmPage_condition" />
   order by UNGROUP DESC, pm.CREATE_DATE DESC
   limit ${start} , ${limit}
  </select>
  
  <select id="findNewPmPageCount" resultType="int" parameterType="com.lj.business.member.dto.FindNewPmPage" >
   SELECT count(*)
	   FROM PERSON_MEMBER pm,
       PERSON_MEMBER_BASE pmb,
       PM_TYPE pt
	 <include refid="findNewPmPage_condition" />
  </select>
  
  <!-- 分页查询紧急客户信息 -->
   <select id="findUrgentMbrPage" resultMap="findUrgentMbrPageResultMap" parameterType="com.lj.business.member.dto.FindUrgentMbrPage" >
    SELECT pm.MEMBER_NO,pm.MEMBER_NAME,pm.MEMBER_NO_GM,pm.MEMBER_NAME_GM,pmb.NO_WX,pm.NICK_NAME_REMARK_WX,pmb.NICK_NAME_WX,pmb.HEAD_ADDRESS,bp.BEHAVIOR_DESC
	FROM PERSON_MEMBER_BASE pmb, PERSON_MEMBER pm, BEHAVIOR_PM bp
	 <include refid="findUrgentMbrPage_condition" />
   order by pm.CREATE_DATE ${sortDir}
   limit ${start} , ${limit}
  </select>
  
   <select id="findPersonMemberSums" resultType="int" parameterType="com.lj.business.member.dto.FindUrgentMbrPage" >
   SELECT count(MEMBER_NO)
   FROM PERSON_MEMBER
   WHERE MERCHANT_NO = #{merchantNo}
  </select>
   <!-- 统计 -->
   <select id="findPersonMemberSexCount" resultMap="findUrgentMbrPageResultMap" parameterType="com.lj.business.member.dto.FindPersonMember" >
   SELECT COUNT(pm.MEMBER_NO) AS count,pmb.SEX
    FROM person_member pm
    LEFT JOIN person_member_base pmb ON pm.MEMBER_NO=pmb.MEMBER_NO
    <include refid="findPersonMemberSex" />
    GROUP BY pmb.SEX,pmb.PROVINCE_CODE ORDER BY COUNT(pm.MEMBER_NO) DESC  LIMIT 1
   </select>
  
  
  <select id="findUrgentMbrPageCount" resultType="int" parameterType="com.lj.business.member.dto.FindUrgentMbrPage" >
   SELECT count(*)
	  FROM PERSON_MEMBER_BASE pmb, PERSON_MEMBER pm,BEHAVIOR_PM bp
	 <include refid="findUrgentMbrPage_condition" />
  </select>
  
   <!-- 客户管理搜索：搜索页面,分页查询 -->
   <select id="findPmSeachPage" resultMap="findPmSeachPageResultMap" parameterType="com.lj.business.member.dto.FindPmTypeIndexPage">
   SELECT DISTINCT pm.code,pm.MEMBER_NO,pm.MEMBER_NAME,pm.MEMBER_NO_GM,pm.MEMBER_NAME_GM,pmb.NO_WX,pm.NICK_NAME_REMARK_WX,pm.NICK_NAME_REMARK_LOCAL,pm.WX_FRIENDS,
   pmb.NICK_NAME_WX,pmb.HEAD_ADDRESS,pmb.RATIO_CLIENT_INFO,bp.BEHAVIOR_DESC,bp.BEHAVIOR_DATE,pmb.MOBILE,pm.SHOP_WX
   FROM PERSON_MEMBER_BASE pmb, 
   PERSON_MEMBER pm, 
   BEHAVIOR_PM bp
	 <include refid="findPmSeachPage_condition" />
   order by pm.CREATE_DATE ${sortDir}
   limit ${start} , ${limit}
  </select>
  
  <select id="findPmSeachPageCount" resultType="int" parameterType="com.lj.business.member.dto.FindPmSeachPage" >
   SELECT count(*)
	  FROM PERSON_MEMBER_BASE pmb, 
	  PERSON_MEMBER pm, 
	  BEHAVIOR_PM bp
	 <include refid="findPmSeachPage_condition" />
  </select>
  
  <!-- 客户管理搜索：搜索页面,分页查询(非邀约版) -->
  <select id="findPmSeachPageHc" resultMap="findPmSeachPageResultMap" parameterType="com.lj.business.member.dto.FindPmTypeIndexPage">
   SELECT DISTINCT pm.code,pm.MEMBER_NO,pm.MEMBER_NAME,pm.MEMBER_NO_GM,pm.MEMBER_NAME_GM,pmb.NO_WX,pm.NICK_NAME_REMARK_WX,pm.NICK_NAME_REMARK_LOCAL,pm.WX_FRIENDS,
   pmb.NICK_NAME_WX,pmb.HEAD_ADDRESS,pmb.RATIO_CLIENT_INFO,bp.BEHAVIOR_DESC,bp.BEHAVIOR_DATE,pmb.MOBILE
   FROM PERSON_MEMBER_BASE pmb, 
   PERSON_MEMBER pm, 
   BEHAVIOR_PM bp
	 <include refid="findPmSeachPageHc_condition" />
   order by pm.CREATE_DATE ${sortDir}
   limit ${start} , ${limit}
  </select>
  
  <select id="findPmSeachPageCountHc" resultType="int" parameterType="com.lj.business.member.dto.FindPmSeachPage" >
   SELECT count(*)
	  FROM PERSON_MEMBER_BASE pmb, 
	  PERSON_MEMBER pm, 
	  BEHAVIOR_PM bp
	 <include refid="findPmSeachPageHc_condition" />
  </select>
  
  
   <!-- 客户管理首页：分类信息明细查询,分页查询 -->
   <select id="findPmTypeIndexPage" resultMap="findPmTypeIndexPageResultMap" parameterType="com.lj.business.member.dto.FindPmTypeIndexPage" >
 SELECT pm.MEMBER_NO,pm.MEMBER_NAME,pm.MEMBER_NO_GM,pm.MEMBER_NAME_GM,pmb.NO_WX,pm.NICK_NAME_REMARK_WX,pm.NICK_NAME_REMARK_LOCAL,pm.WX_FRIENDS
        ,pmb.NICK_NAME_WX,pmb.HEAD_ADDRESS,
        bp.BEHAVIOR_DESC,bp.BEHAVIOR_DATE,
        pm.URGENCY_PM,
        pmb.MOBILE,pmb.RATIO_CLIENT_INFO,
        pm.CREATE_DATE, pm.CONSUME_FREQUENCY,
        pm.SHOP_WX
	  FROM PERSON_MEMBER_BASE pmb, 
	  PERSON_MEMBER pm, 
	  BEHAVIOR_PM bp
	 <include refid="findPmTypeIndexPage_condition" />
   order by pm.CREATE_DATE ${sortDir}, pm.MEMBER_NAME asc
   limit ${start} , ${limit}
  </select>
  
  <select id="findPmTypeIndexPageCount" resultType="int" parameterType="com.lj.business.member.dto.FindPmTypeIndexPage" >
   SELECT count(*)
	  FROM PERSON_MEMBER_BASE pmb, 
	  PERSON_MEMBER pm, 
	  BEHAVIOR_PM bp
	 <include refid="findPmTypeIndexPage_condition" />
  </select>
  
  <select id="findAllCustomerCount" resultType="int" parameterType="com.lj.business.member.dto.FindPmTypeIndexPage" >
   SELECT count(*)
	  FROM PERSON_MEMBER pm
	 WHERE pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
  </select>

  
   <select id="findPmTypeRepeatCount" resultType="int" parameterType="com.lj.business.member.domain.PersonMember" >
        SELECT count(*)
		  FROM PERSON_MEMBER pm
		 WHERE pm.MEMBER_NO = #{memberNo,jdbcType=VARCHAR}
		  AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
  </select>
  
     <!-- 分页查询 -->
   <select id="findPersonMemberPage" resultMap="findPersonMemberPageResultMap" parameterType="com.lj.business.member.dto.FindPersonMemberPage" >
  SELECT  <include refid="Join_Column_List_noinvite" />
  FROM person_member pm
  INNER JOIN person_member_base  pmb ON pm.MEMBER_NO=pmb.MEMBER_NO
  LEFT JOIN pm_type pt ON pt.CODE = pm.PM_TYPE_CODE
  <include refid="findPersonMemberPage_condition"/>
	  GROUP BY pm.CODE
	   ORDER BY pm.CREATE_DATE ${sortDir}
	   limit ${start},${limit}
  </select>
  
   <!-- 客户列表查询    不要在这里加关联或修改这个 sql -->
  <select id="queryPersonMemberPage" resultMap="findPersonMemberPageResultMap" parameterType="com.lj.business.member.dto.FindPersonMemberPage">
  SELECT pm.PM_TYPE_CODE,pm.PM_TYPE_NAME,pm.MERCHANT_NO
  		,IF(pm.NICK_NAME_REMARK_WX IS NULL OR pm.NICK_NAME_REMARK_WX='',pm.MEMBER_NAME,pm.NICK_NAME_REMARK_WX) MEMBER_NAME
  		,pm.MEMBER_NAME_GM,pm.MEMBER_NO_GM,pm.MEMBER_NO,pm.CODE,pm.ADD_TYPE,pmb.CODE BASE_CODE
	  ,pmb.NO_WX,pmb.NO_WW ,pmb.HEAD_ADDRESS,pmb.NO_WX_ALIAS,pmb.NICK_NAME_WX,pmb.WX_OPENID,pm.SPRUCE_UP,pm.BRAND_COMPARE
	  ,pmb.MOBILE,pmb.SEX,pmb.PROVINCE_CODE,pmb.CITY_AREA_CODE,pmb.CITY_CODE,pm.HOUSES,pmb.MEMBER_SRC,pm.CREATE_DATE,pm.CLIENT_SPECIAL,pm.REMARK
	  ,pm.SHOP_WX
	  ,(SELECT CONCAT(st.no_wx,'-',st.NICK_NAME) FROM shop_terminal st WHERE st.NO_WX = pm.SHOP_WX) BOM_NAME
   FROM  person_member pm  
   LEFT JOIN person_member_base pmb  on pm.MEMBER_NO=pmb.MEMBER_NO
  <include refid="findPersonMemberPage_condition"/>
   GROUP BY pm.CODE
   ORDER BY pm.CREATE_DATE ${sortDir}
   limit ${start},${limit}
  </select>
    
    <select id="queryPersonMemberPageCount" resultType="int" parameterType="com.lj.business.member.dto.FindPersonMemberPage" >
    select  count(DISTINCT pm.CODE)
     FROM person_member pm
     INNER JOIN person_member_base  pmb ON pm.MEMBER_NO=pmb.MEMBER_NO
     <include refid="findPersonMemberPage_condition" />
  </select>
  
  
  <!-- 查询客户列表 -->
   <select id="findPersonMemberList" resultMap="findPersonMemberPageResultMap" parameterType="com.lj.business.member.dto.FindPersonMemberPage" >
  SELECT  <include refid="Join_Column_List" />
  FROM person_member pm
  INNER JOIN person_member_base  pmb ON pm.MEMBER_NO=pmb.MEMBER_NO
  LEFT JOIN pm_type pt ON pt.CODE = pm.PM_TYPE_CODE
  LEFT JOIN guid_member gm ON pm.MEMBER_NO_GM=gm.MEMBER_NO
  <include refid="findPersonMemberPage_condition"/>
  </select>
  
  <!-- 根据商户指定标签查询客户列表 2018年1月9日14:25:11-->
   <select id="findPmbListByLabelCode" resultMap="findPersonMemberPageResultMap" parameterType="map" >
  	SELECT pmb.* FROM person_member pm
	INNER JOIN person_member_base pmb ON pm.MEMBER_NO = pmb.MEMBER_NO
	INNER JOIN PM_LABEL_PM plp ON pmb.MEMBER_NO = plp.MEMBER_NO
	WHERE pm.MERCHANT_NO =#{merchantNo} AND plp.PM_LABEL_CODE =#{pmLabelCode}
  </select>
  
  
  <select id="findPersonMemberPageCount" resultType="int" parameterType="com.lj.business.member.dto.FindPersonMemberPage" >
    select  count(DISTINCT pm.CODE)
     FROM person_member pm
     INNER JOIN person_member_base  pmb ON pm.MEMBER_NO=pmb.MEMBER_NO
	  LEFT JOIN pm_type pt ON pt.CODE = pm.PM_TYPE_CODE
	  LEFT JOIN guid_member gm ON pm.MEMBER_NO_GM=gm.MEMBER_NO
     <include refid="findPersonMemberPage_condition" />
  </select>
  
 
 <select id="getByCond" resultMap="findPersonMemberPageResultMap" parameterType="map" >
    select <include refid="Join_Column_List" />
     FROM person_member pm
     INNER JOIN person_member_base  pmb ON pm.MEMBER_NO=pmb.MEMBER_NO
	  <where>
	  	<if test="code != null and code != ''">
	  		and pm.CODE = #{code,jdbcType=VARCHAR}
	  	</if>
	  	<if test="memberNo != null and memberNo != ''">
	  		and pm.MEMBER_NO = #{memberNo,jdbcType=VARCHAR}
	  	</if>
	  	<if test="merchantNo != null and merchantNo != ''">
	  		and pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
	  	</if>
	  	<if test="shopWx != null and shopWx != ''" >
       		AND pm.SHOP_WX = #{shopWx,jdbcType=VARCHAR}
      </if>
	  </where>
	  LIMIT 1
  </select>
 <select id="selectByParamKey" resultMap="BaseResultMap" parameterType="com.lj.business.member.domain.PersonMember" >
     select 
    <include refid="Base_Column_List" />
    from person_member
    <where>
      <if test="code != null and code != ''" >
       	AND CODE = #{code,jdbcType=VARCHAR}
      </if>
      <if test="memberNo != null and memberNo != ''" >
       	AND MEMBER_NO = #{memberNo,jdbcType=VARCHAR}
      </if>
      <if test="memberNoGm != null and memberNoGm != ''" >
       	AND MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
      </if>
      <if test="merchantNo != null and merchantNo != ''" >
       	AND MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
      </if>
      <if test="shopWx != null and shopWx != ''" >
       	AND SHOP_WX = #{shopWx,jdbcType=VARCHAR}
      </if>
    </where>
    
  </select>
  
  <select id="findPmWxBpInfo" resultMap="findPmWxBpInfoResultMap" parameterType="com.lj.business.member.dto.FindPmWxBpInfo" >
    SELECT pm.MEMBER_NO,pm.NICK_NAME_REMARK_WX, pm.NICK_NAME_REMARK_LOCAL,  pmb.NO_WX,pmb.NICK_NAME_WX,pmb.HEAD_ADDRESS,bp.BEHAVIOR_DESC,bp.BEHAVIOR_DATE
  FROM PERSON_MEMBER pm, PERSON_MEMBER_BASE pmb, BEHAVIOR_PM bp
 WHERE     pmb.MEMBER_NO = bp.MEMBER_NO
       AND pmb.MEMBER_NO = pm.MEMBER_NO
        AND pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
	  AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
       AND pm.MEMBER_NO in (
               <foreach item="memberNoArItem" index="index" collection="memberNoAr"
                   separator=","> #{memberNoArItem} </foreach>
              )
  </select>

   <select id="findPmWxInfo" resultMap="findPmWxInfoResultMap" parameterType="com.lj.business.member.dto.FindPmWxInfo" >
	   SELECT pm.MEMBER_NO,
	       pm.NICK_NAME_REMARK_WX,
	       pm.NICK_NAME_REMARK_LOCAL,
	       pmb.NO_WX,
	       pmb.NICK_NAME_WX,
	       pmb.HEAD_ADDRESS,
	       pmb.MOBILE,
	       pmb.SEX
	  FROM PERSON_MEMBER pm, PERSON_MEMBER_BASE pmb
	 WHERE pmb.MEMBER_NO = pm.MEMBER_NO
	  AND pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
	  AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
       AND pm.MEMBER_NO in (
               <foreach item="memberNoArItem" index="index" collection="memberNoAr" 
                   separator=","> #{memberNoArItem} </foreach> 
              ) 
  </select>
  
  <select id="findPmWxInfos" resultMap="findPmWxInfoResultMap" parameterType="com.lj.business.member.dto.FindPmWxInfos" >
	   SELECT pm.MEMBER_NO,
	       pm.NICK_NAME_REMARK_WX,
	       pm.NICK_NAME_REMARK_LOCAL,
	       pmb.NO_WX,
	       pmb.NICK_NAME_WX,
	       pmb.HEAD_ADDRESS,
	       pmb.MOBILE,
	       pmb.SEX,pmb.WX_OPENID
	  FROM PERSON_MEMBER pm, PERSON_MEMBER_BASE pmb
	 WHERE pmb.MEMBER_NO = pm.MEMBER_NO
	  AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
       AND pm.WX_OPENID in (
               <foreach item="item" index="index" collection="wxOpenId" separator=","> #{item} </foreach> 
              ) 
  </select>
  
  <select id="findCountByMemberNo" parameterType="com.lj.business.member.dto.FindPersonMember" resultType="int">
  	 select count(*)
  	 from person_member
  	 where MEMBER_NO = #{memberNo,jdbcType=VARCHAR} AND MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
  </select>

    <sql id="findUnContactMember_condition">
	    <where>
	        <if test="startDate != null" >
	            <![CDATA[
	              and m.time >= #{startDate}
	            ]]>
	        </if>
	        <if test="endDate != null" >
	            <![CDATA[
	              and m.time <= #{endDate}
	            ]]>
	        </if>
	    </where>
    </sql>
    <select id="findUnContactMember" resultMap="findUnContactMemberResultMap" parameterType="com.lj.business.member.dto.FindUnContactMember">
        select pmb.MEMBER_NO, pm.MEMBER_NAME, pmb.MOBILE, pmb.NO_WX, pmb.NICK_NAME_WX,pm.WX_FRIENDS,
        pmb.HEAD_ADDRESS, pm.NICK_NAME_REMARK_WX, pm.NICK_NAME_REMARK_LOCAL, bp.BEHAVIOR_DATE, bp.BEHAVIOR_DESC
        from (SELECT t.member_no, t.member_no_gm, MAX(t.time) time
		FROM (SELECT member_no,member_no_gm,CONTACT_DATE_LAST time FROM person_member WHERE MEMBER_NO_GM = #{memberNoGm} UNION
		SELECT member_no,member_no_gm,CHAT_TIME time FROM 
		pm_chat_behavior WHERE MEMBER_NO_GM = #{memberNoGm}) t
		GROUP BY t.member_no) m
		LEFT JOIN person_member pm ON m.MEMBER_NO = pm.MEMBER_NO AND m.member_no_gm = pm.member_no_gm
		left join person_member_base pmb on m.MEMBER_NO = pmb.MEMBER_NO
		left JOIN BEHAVIOR_PM bp on m.MEMBER_NO = bp.MEMBER_NO
		<include refid="findUnContactMember_condition" />
        order by bp.BEHAVIOR_DATE desc
        limit ${start} , ${limit}
    </select>
    
    <!-- 根据分类查询未联系顾客信息含标签 -->
    <select id="findUnContactMemberByPmType" resultMap="findUnContactMemberByPmTypeResultMap" parameterType="com.lj.business.member.dto.FindUnContactMember">
    	select pmb.MEMBER_NO, pm.MEMBER_NAME, pmb.MOBILE, pmb.NO_WX, pmb.NICK_NAME_WX,pm.WX_FRIENDS,
        pmb.HEAD_ADDRESS, pm.NICK_NAME_REMARK_WX, bp.BEHAVIOR_DATE, bp.BEHAVIOR_DESC
        from (SELECT t.member_no, t.member_no_gm, MAX(t.time) time
		FROM (SELECT member_no,member_no_gm,CONTACT_DATE_LAST time FROM person_member WHERE MEMBER_NO_GM = #{memberNoGm} UNION
		SELECT member_no,member_no_gm,CHAT_TIME time FROM pm_chat_behavior WHERE MEMBER_NO_GM = #{memberNoGm}) t
		GROUP BY t.member_no) m
		LEFT JOIN person_member pm ON m.MEMBER_NO = pm.MEMBER_NO AND m.member_no_gm = pm.member_no_gm
		left join person_member_base pmb on m.MEMBER_NO = pmb.MEMBER_NO
		left JOIN BEHAVIOR_PM bp on m.MEMBER_NO = bp.MEMBER_NO
        left join PM_LABEL_PM plp on pm.MEMBER_NO = plp.MEMBER_NO
        left join PM_LABEL pl on plp.PM_LABEL_CODE = pl.CODE and pm.MERCHANT_NO = pl.MERCHANT_NO
        where pm.MERCHANT_NO = #{merchantNo} and pm.MEMBER_NO_GM = #{memberNoGm} 
        and pm.pm_type_code = #{pmTypeCode}
		<if test="startDate != null" >
	            <![CDATA[
	              and m.time >= #{startDate}
	            ]]>
	        </if>
	    <if test="endDate != null" >
	            <![CDATA[
	              and m.time <= #{endDate}
	            ]]>
	     </if>
        order by bp.BEHAVIOR_DATE desc
    </select>

    <select id="findUnContactMemberCount" resultType="int" parameterType="com.lj.business.member.dto.FindUnContactMember" >
    	select count(*) from
    	(SELECT t.member_no, t.member_no_gm, MAX(t.time) time
		FROM (SELECT member_no,member_no_gm,CONTACT_DATE_LAST time FROM person_member WHERE MEMBER_NO_GM = #{memberNoGm} UNION
		SELECT member_no,member_no_gm,CHAT_TIME time FROM pm_chat_behavior WHERE MEMBER_NO_GM = #{memberNoGm}) t
		GROUP BY t.member_no) m
        <include refid="findUnContactMember_condition" />
    </select>

    <select id="findCountByMemberNoGm" resultType="int" >
        SELECT count(*) FROM PERSON_MEMBER
        WHERE MEMBER_NO_GM = #{memberNoGm} AND MERCHANT_NO = #{merchantNo}
    </select>
  
  
   
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="com.lj.business.member.domain.PersonMember" >
   select 
    <include refid="Base_Column_List" />
    from person_member
    where CODE = #{code,jdbcType=VARCHAR}
  </select>
  
   <select id="selectByMGM" resultMap="BaseResultMap" parameterType="com.lj.business.member.dto.FindPersonMember" >
    select 
    <include refid="Base_Column_List" />
    from person_member
    where MEMBER_NO = #{memberNo,jdbcType=VARCHAR} 
    AND SHOP_WX = #{shopWx,jdbcType=VARCHAR}
    <if test="memberNoGm != null and memberNoGm !=''" >
        AND MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
    </if>
  </select>
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    delete from person_member
    where CODE = #{code,jdbcType=VARCHAR}
  </delete>
  <insert id="insertSelective" parameterType="com.lj.business.member.domain.PersonMember" >
    insert into person_member
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="code != null" >
        CODE,
      </if>
      <if test="memberNo != null" >
        MEMBER_NO,
      </if>
      <if test="memberName != null" >
        MEMBER_NAME,
      </if>
      <if test="memberNoGm != null" >
        MEMBER_NO_GM,
      </if>
      <if test="memberNameGm != null" >
        MEMBER_NAME_GM,
      </if>
      <if test="merchantNo != null" >
        MERCHANT_NO,
      </if>
      <if test="merchantName != null" >
        MERCHANT_NAME,
      </if>
      <if test="spruceUp != null" >
        SPRUCE_UP,
      </if>
      <if test="houses != null" >
        HOUSES,
      </if>
      <if test="keepEye != null" >
        KEEP_EYE,
      </if>
      <if test="urgencyPm != null" >
        URGENCY_PM,
      </if>
      <if test="bomCode != null" >
        BOM_CODE,
      </if>
      <if test="bomName != null" >
        BOM_NAME,
      </if>
      <if test="nickNameRemarkWx != null" >
        NICK_NAME_REMARK_WX,
      </if>
      <if test="nickNameRemarkLocal != null" >
        NICK_NAME_REMARK_LOCAL,
      </if>
      <if test="contactDateLast != null" >
        CONTACT_DATE_LAST,
      </if>
      <if test="brandCompare != null" >
        BRAND_COMPARE,
      </if>
      <if test="clientSpecial != null" >
        CLIENT_SPECIAL,
      </if>
      <if test="consumeFrequency != null" >
        CONSUME_FREQUENCY,
      </if>
      <if test="scanAddress != null" >
        SCAN_ADDRESS,
      </if>
      <if test="latitude != null" >
        LATITUDE,
      </if>
      <if test="longitude != null" >
        LONGITUDE,
      </if>
      <if test="firstIntroduce != null" >
        FIRST_INTRODUCE,
      </if>
      <if test="expectPurchaseTime != null" >
        EXPECT_PURCHASE_TIME,
      </if>
      <if test="expTime != null" >
        EXP_TIME,
      </if>
      <if test="wxFriends != null" >
        WX_FRIENDS,
      </if>
      <if test="addType != null" >
        ADD_TYPE,
      </if>
      <if test="version != null" >
        VERSION,
      </if>
      <if test="createId != null" >
        CREATE_ID,
      </if>
        CREATE_DATE,
      <if test="updateId != null" >
        UPDATE_ID,
      </if>
      <if test="updateDate != null" >
        UPDATE_DATE,
      </if>
      <if test="remark4 != null" >
        REMARK4,
      </if>
      <if test="remark3 != null" >
        REMARK3,
      </if>
      <if test="remark2 != null" >
        REMARK2,
      </if>
      <if test="remark != null" >
        REMARK,
      </if>
      <if test="pmTypeCode != null" >
        pmTypeCode,
      </if>
      <if test="pmTypeName != null" >
        pmTypeName,
      </if>
      <if test="shopWx != null" >
        SHOP_WX,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="code != null" >
        #{code,jdbcType=VARCHAR},
      </if>
      <if test="memberNo != null" >
        #{memberNo,jdbcType=VARCHAR},
      </if>
      <if test="memberName != null" >
        #{memberName,jdbcType=VARCHAR},
      </if>
      <if test="memberNoGm != null" >
        #{memberNoGm,jdbcType=VARCHAR},
      </if>
      <if test="memberNameGm != null" >
        #{memberNameGm,jdbcType=VARCHAR},
      </if>
      <if test="merchantNo != null" >
        #{merchantNo,jdbcType=VARCHAR},
      </if>
      <if test="merchantName != null" >
        #{merchantName,jdbcType=VARCHAR},
      </if>
      <if test="spruceUp != null" >
        #{spruceUp,jdbcType=VARCHAR},
      </if>
      <if test="houses != null" >
        #{houses,jdbcType=VARCHAR},
      </if>
      <if test="keepEye != null" >
        #{keepEye,jdbcType=VARCHAR},
      </if>
      <if test="urgencyPm != null" >
        #{urgencyPm,jdbcType=VARCHAR},
      </if>
      <if test="bomCode != null" >
        #{bomCode,jdbcType=VARCHAR},
      </if>
      <if test="bomName != null" >
        #{bomName,jdbcType=VARCHAR},
      </if>
      <if test="nickNameRemarkWx != null" >
        #{nickNameRemarkWx,jdbcType=VARCHAR},
      </if>
      <if test="nickNameRemarkLocal != null" >
        #{nickNameRemarkLocal,jdbcType=VARCHAR},
      </if>
      <if test="contactDateLast != null" >
        #{contactDateLast,jdbcType=TIMESTAMP},
      </if>
      <if test="brandCompare != null" >
        #{brandCompare,jdbcType=VARCHAR},
      </if>
      <if test="clientSpecial != null" >
        #{clientSpecial,jdbcType=VARCHAR},
      </if>
      <if test="consumeFrequency != null" >
        #{consumeFrequency,jdbcType=VARCHAR},
      </if>
      <if test="scanAddress != null" >
        #{scanAddress,jdbcType=VARCHAR},
      </if>
      <if test="latitude != null" >
        #{latitude,jdbcType=VARCHAR},
      </if>
      <if test="longitude != null" >
        #{longitude,jdbcType=VARCHAR},
      </if>
      <if test="firstIntroduce != null" >
        #{firstIntroduce,jdbcType=VARCHAR},
      </if>
      <if test="expectPurchaseTime != null" >
        #{expectPurchaseTime,jdbcType=VARCHAR},
      </if>
      <if test="expTime != null" >
        #{expTime,jdbcType=VARCHAR},
      </if>
      <if test="wxFriends != null" >
        #{wxFriends,jdbcType=INTEGER},
      </if>
      <if test="addType != null" >
        #{addType,jdbcType=INTEGER},
      </if>
      <if test="version != null" >
        #{version,jdbcType=BIGINT},
      </if>
      <if test="createId != null" >
        #{createId,jdbcType=VARCHAR},
      </if>
        NOW(),
      <if test="updateId != null" >
        #{updateId,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null" >
        #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="remark4 != null" >
        #{remark4,jdbcType=VARCHAR},
      </if>
      <if test="remark3 != null" >
        #{remark3,jdbcType=VARCHAR},
      </if>
      <if test="remark2 != null" >
        #{remark2,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="pmTypeCode != null" >
        #{pmTypeCode,jdbcType=VARCHAR},
      </if>
      <if test="pmTypeName != null" >
        #{pmTypeName,jdbcType=VARCHAR},
      </if>
      <if test="shopWx != null" >
        #{shopWx,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.lj.business.member.domain.PersonMember" >
    update person_member
    <set >
      <if test="memberNo != null" >
        MEMBER_NO = #{memberNo,jdbcType=VARCHAR},
      </if>
      <if test="memberName != null" >
        MEMBER_NAME = #{memberName,jdbcType=VARCHAR},
      </if>
      <if test="memberNoGm != null" >
        MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR},
      </if>
      <if test="memberNameGm != null" >
        MEMBER_NAME_GM = #{memberNameGm,jdbcType=VARCHAR},
      </if>
      <if test="merchantNo != null" >
        MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR},
      </if>
      <if test="merchantName != null" >
        MERCHANT_NAME = #{merchantName,jdbcType=VARCHAR},
      </if>
      <if test="spruceUp != null" >
        SPRUCE_UP = #{spruceUp,jdbcType=VARCHAR},
      </if>
      <if test="houses != null" >
        HOUSES = #{houses,jdbcType=VARCHAR},
      </if>
      <if test="keepEye != null" >
        KEEP_EYE = #{keepEye,jdbcType=VARCHAR},
      </if>
      <if test="urgencyPm != null" >
        URGENCY_PM = #{urgencyPm,jdbcType=VARCHAR},
      </if>
      <if test="bomCode != null" >
        BOM_CODE = #{bomCode,jdbcType=VARCHAR},
      </if>
      <if test="bomName != null" >
        BOM_NAME = #{bomName,jdbcType=VARCHAR},
      </if>
      <if test="nickNameRemarkWx != null" >
        NICK_NAME_REMARK_WX = #{nickNameRemarkWx,jdbcType=VARCHAR},
      </if>
      <if test="nickNameRemarkLocal != null" >
        NICK_NAME_REMARK_LOCAL = #{nickNameRemarkLocal,jdbcType=VARCHAR},
      </if>
      <if test="contactDateLast != null" >
        CONTACT_DATE_LAST = #{contactDateLast,jdbcType=TIMESTAMP},
      </if>
      <if test="brandCompare != null" >
        BRAND_COMPARE = #{brandCompare,jdbcType=VARCHAR},
      </if>
      <if test="clientSpecial != null" >
        CLIENT_SPECIAL = #{clientSpecial,jdbcType=VARCHAR},
      </if>
      <if test="consumeFrequency != null" >
        CONSUME_FREQUENCY = #{consumeFrequency,jdbcType=VARCHAR},
      </if>
      <if test="scanAddress != null" >
        SCAN_ADDRESS = #{scanAddress,jdbcType=VARCHAR},
      </if>
      <if test="latitude != null" >
        LATITUDE = #{latitude,jdbcType=VARCHAR},
      </if>
      <if test="longitude != null" >
        LONGITUDE = #{longitude,jdbcType=VARCHAR},
      </if>
      <if test="firstIntroduce != null" >
        FIRST_INTRODUCE = #{firstIntroduce,jdbcType=VARCHAR},
      </if>
      <if test="expectPurchaseTime != null" >
        EXPECT_PURCHASE_TIME = #{expectPurchaseTime,jdbcType=VARCHAR},
      </if>
      <if test="expTime != null" >
        EXP_TIME = #{expTime,jdbcType=VARCHAR},
      </if>
      <if test="wxFriends != null" >
        WX_FRIENDS = #{wxFriends,jdbcType=INTEGER},
      </if>
      <if test="addType != null" >
        ADD_TYPE = #{addType,jdbcType=INTEGER},
      </if>
      <if test="version != null" >
        VERSION = #{version,jdbcType=BIGINT},
      </if>
      <if test="createId != null" >
        CREATE_ID = #{createId,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null" >
        CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateId != null" >
        UPDATE_ID = #{updateId,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null" >
        UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="remark4 != null" >
        REMARK4 = #{remark4,jdbcType=VARCHAR},
      </if>
      <if test="remark3 != null" >
        REMARK3 = #{remark3,jdbcType=VARCHAR},
      </if>
      <if test="remark2 != null" >
        REMARK2 = #{remark2,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        REMARK = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="pmTypeCode != null" >
        PM_TYPE_CODE = #{pmTypeCode,jdbcType=VARCHAR},
      </if>
      <if test="pmTypeName != null" >
        PM_TYPE_NAME = #{pmTypeName,jdbcType=VARCHAR},
      </if>
      <if test="shopWx != null" >
        SHOP_WX = #{shopWx,jdbcType=VARCHAR},
      </if>
    </set>
    where CODE = #{code,jdbcType=VARCHAR}
  </update>
  
  
  <update id="updateByMGM" parameterType="com.lj.business.member.domain.PersonMember" >
    update person_member
    <set >
      <if test="memberName != null" >
        MEMBER_NAME = #{memberName,jdbcType=VARCHAR},
      </if>
      <if test="memberNameGm != null" >
        MEMBER_NAME_GM = #{memberNameGm,jdbcType=VARCHAR},
      </if>
      <if test="merchantNo != null" >
        MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR},
      </if>
      <if test="merchantName != null" >
        MERCHANT_NAME = #{merchantName,jdbcType=VARCHAR},
      </if>
      <if test="spruceUp != null" >
        SPRUCE_UP = #{spruceUp,jdbcType=VARCHAR},
      </if>
      <if test="houses != null" >
        HOUSES = #{houses,jdbcType=VARCHAR},
      </if>
      <if test="keepEye != null" >
        KEEP_EYE = #{keepEye,jdbcType=VARCHAR},
      </if>
      <if test="urgencyPm != null" >
        URGENCY_PM = #{urgencyPm,jdbcType=VARCHAR},
      </if>
      <if test="bomCode != null" >
        BOM_CODE = #{bomCode,jdbcType=VARCHAR},
      </if>
      <if test="bomName != null" >
        BOM_NAME = #{bomName,jdbcType=VARCHAR},
      </if>
      <if test="nickNameRemarkWx != null" >
        NICK_NAME_REMARK_WX = #{nickNameRemarkWx,jdbcType=VARCHAR},
      </if>
      <if test="nickNameRemarkLocal != null" >
        NICK_NAME_REMARK_LOCAL = #{nickNameRemarkLocal,jdbcType=VARCHAR},
      </if>
      <if test="brandCompare != null" >
        BRAND_COMPARE = #{brandCompare,jdbcType=VARCHAR},
      </if>
      <if test="clientSpecial != null" >
        CLIENT_SPECIAL = #{clientSpecial,jdbcType=VARCHAR},
      </if>
      <if test="consumeFrequency != null" >
        CONSUME_FREQUENCY = #{consumeFrequency,jdbcType=VARCHAR},
      </if>
      <if test="firstIntroduce != null" >
        FIRST_INTRODUCE = #{firstIntroduce,jdbcType=VARCHAR},
      </if>
      <if test="expectPurchaseTime != null" >
        EXPECT_PURCHASE_TIME = #{expectPurchaseTime,jdbcType=VARCHAR},
      </if>
      <if test="expTime != null" >
        EXP_TIME = #{expTime,jdbcType=VARCHAR},
      </if>
      <if test="wxFriends != null" >
        WX_FRIENDS = #{wxFriends,jdbcType=INTEGER},
      </if>
      <if test="addType != null" >
        ADD_TYPE = #{addType,jdbcType=INTEGER},
      </if>
      <if test="version != null" >
        VERSION = #{version,jdbcType=BIGINT},
      </if>
      <if test="createId != null" >
        CREATE_ID = #{createId,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null" >
        CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateId != null" >
        UPDATE_ID = #{updateId,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null" >
        UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="remark4 != null" >
        REMARK4 = #{remark4,jdbcType=VARCHAR},
      </if>
      <if test="remark3 != null" >
        REMARK3 = #{remark3,jdbcType=VARCHAR},
      </if>
      <if test="remark2 != null" >
        REMARK2 = #{remark2,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        REMARK = #{remark,jdbcType=VARCHAR},
      </if>
       <if test="contactDateLast != null" >
        CONTACT_DATE_LAST = #{contactDateLast,jdbcType=VARCHAR},
      </if>
      <if test="pmTypeCode != null" >
        PM_TYPE_CODE = #{pmTypeCode,jdbcType=VARCHAR},
      </if>
      <if test="pmTypeName != null" >
        PM_TYPE_NAME = #{pmTypeName,jdbcType=VARCHAR},
      </if>
    </set>
    where MEMBER_NO = #{memberNo,jdbcType=VARCHAR} AND SHOP_WX = #{shopWx,jdbcType=VARCHAR}
  </update>



<update id="updatePersonMemberByCond" parameterType="com.lj.business.member.domain.PersonMember" >
    update person_member
    <set >
      <if test="memberName != null" >
        MEMBER_NAME = #{memberName,jdbcType=VARCHAR},
      </if>
      <if test="memberNameGm != null" >
        MEMBER_NAME_GM = #{memberNameGm,jdbcType=VARCHAR},
      </if>
      <if test="merchantNo != null" >
        MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR},
      </if>
      <if test="merchantName != null" >
        MERCHANT_NAME = #{merchantName,jdbcType=VARCHAR},
      </if>
      <if test="spruceUp != null" >
        SPRUCE_UP = #{spruceUp,jdbcType=VARCHAR},
      </if>
      <if test="houses != null" >
        HOUSES = #{houses,jdbcType=VARCHAR},
      </if>
      <if test="keepEye != null" >
        KEEP_EYE = #{keepEye,jdbcType=VARCHAR},
      </if>
      <if test="urgencyPm != null" >
        URGENCY_PM = #{urgencyPm,jdbcType=VARCHAR},
      </if>
      <if test="bomCode != null" >
        BOM_CODE = #{bomCode,jdbcType=VARCHAR},
      </if>
      <if test="bomName != null" >
        BOM_NAME = #{bomName,jdbcType=VARCHAR},
      </if>
      <if test="nickNameRemarkWx != null" >
        NICK_NAME_REMARK_WX = #{nickNameRemarkWx,jdbcType=VARCHAR},
      </if>
      <if test="nickNameRemarkLocal != null" >
        NICK_NAME_REMARK_LOCAL = #{nickNameRemarkLocal,jdbcType=VARCHAR},
      </if>
      <if test="brandCompare != null" >
        BRAND_COMPARE = #{brandCompare,jdbcType=VARCHAR},
      </if>
      <if test="clientSpecial != null" >
        CLIENT_SPECIAL = #{clientSpecial,jdbcType=VARCHAR},
      </if>
      <if test="consumeFrequency != null" >
        CONSUME_FREQUENCY = #{consumeFrequency,jdbcType=VARCHAR},
      </if>
      <if test="firstIntroduce != null" >
        FIRST_INTRODUCE = #{firstIntroduce,jdbcType=VARCHAR},
      </if>
      <if test="expectPurchaseTime != null" >
        EXPECT_PURCHASE_TIME = #{expectPurchaseTime,jdbcType=VARCHAR},
      </if>
      <if test="expTime != null" >
        EXP_TIME = #{expTime,jdbcType=VARCHAR},
      </if>
      <if test="wxFriends != null" >
        WX_FRIENDS = #{wxFriends,jdbcType=INTEGER},
      </if>
      <if test="addType != null" >
        ADD_TYPE = #{addType,jdbcType=INTEGER},
      </if>
      <if test="version != null" >
        VERSION = #{version,jdbcType=BIGINT},
      </if>
      <if test="createId != null" >
        CREATE_ID = #{createId,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null" >
        CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateId != null" >
        UPDATE_ID = #{updateId,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null" >
        UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="remark4 != null" >
        REMARK4 = #{remark4,jdbcType=VARCHAR},
      </if>
      <if test="remark3 != null" >
        REMARK3 = #{remark3,jdbcType=VARCHAR},
      </if>
      <if test="remark2 != null" >
        REMARK2 = #{remark2,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        REMARK = #{remark,jdbcType=VARCHAR},
      </if>
       <if test="contactDateLast != null" >
        CONTACT_DATE_LAST = #{contactDateLast,jdbcType=VARCHAR},
      </if>
      <if test="pmTypeCode != null" >
        PM_TYPE_CODE = #{pmTypeCode,jdbcType=VARCHAR},
      </if>
      <if test="pmTypeName != null" >
        PM_TYPE_NAME = #{pmTypeName,jdbcType=VARCHAR},
      </if>
    </set>
    where MEMBER_NO = #{memberNo,jdbcType=VARCHAR}
  </update>


    <select id="selectSexStatisticsByShopNo" resultType="map">
        SELECT count(DISTINCT pm.MEMBER_NO) AS 'sexCount',
       pm.MERCHANT_NO AS 'merchantNo',
       pmb.SEX AS 'sex',
       pmb.AREA_CODE AS 'areaCode',
       pmb.AREA_NAME AS 'areaName',
       pm.SHOP_NAME AS 'shopName'
  FROM person_member pm
       INNER JOIN person_member_base pmb ON pm.MEMBER_NO = pmb.MEMBER_NO
GROUP BY pmb.SEX
    </select>

    <select id="selectAgeStatisticsByShopNo" resultType="map">
        select count(DISTINCT pm.MEMBER_NO) as 'ageCount',pm.SHOP_NO as 'shopNo'
        from person_member pm inner join person_member_base pmb on pm.MEMBER_NO = pmb.MEMBER_NO
        WHERE pmb.BIRTHDAY BETWEEN #{beginDate} AND #{endDate}
        group by pm.SHOP_NO
    </select>

    <select id="selectLineStatisticsByShopNo" resultType="map">
        SELECT count(*) as 'numLine', ml.CODE as 'codeLine',ml.NAME as 'lineName',s.SHOP_NAME as 'shopName',
        pm.MERCHANT_NO as 'merchantNo',pm.SHOP_NO as 'shopNo',s.AREA_CODE as 'areaCode'
        from person_member pm left join person_member_base pmb on pm.MEMBER_NO = pmb.MEMBER_NO
         left join mem_line ml on pmb.JOB = ml.CODE
        LEFT JOIN shop s on s.pm.SHOP_NO
         GROUP BY ml.code
    </select>

    <select id="selectInterestStatisticsByShopNo" resultType="map">
        SELECT count(*) as 'numInterest', ip.CODE as 'codeInterest',ip.NAME as 'interestName',s.SHOP_NAME as 'shopName',
        pm.MERCHANT_NO as 'merchantNo',pm.SHOP_NO as 'shopNo',s.AREA_CODE as 'areaCode'
        from person_member pm left join person_member_base pmb on pm.MEMBER_NO = pmb.MEMBER_NO
         left join interest_pm ip on pmb.INTEREST = ip.CODE
        LEFT JOIN shop s on s.pm.SHOP_NO
         GROUP BY pm.ip.code
    </select>
    
    <select id="findList" resultMap="findListResultMap" parameterType="com.lj.business.member.dto.DoRepeatMemberDto">
    	select 
    	<include refid="Base_Column_List"/>
    	from person_member
    	where MEMBER_NO = #{memberNo,jdbcType=VARCHAR} 
    		  AND MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
    </select>
    
    <select id="todayManageShopNew" resultMap="TodayManageShopNewResultMap" parameterType="com.lj.business.member.dto.FindTodayManageShop">
    
	    SELECT gm.MEMBER_NO as MEMBER_NO_GM,
	           gm.MEMBER_NAME as MEMBER_NAME_GM,
	           gm.HEAD_ADDRESS,
	           IFNULL(a.total,0.0)  RATIO_WORK,
	           gm.MERCHANT_NO,
	           gm.
	           gm.SHOP_NAME
		FROM guid_member gm LEFT JOIN 
		(
		SELECT gmid.MEMBER_NO,SUM(INTEGRAL_SCORE) total
		FROM guid_member_integral_day gmid 
		WHERE gmid.#{shopNo,jdbcType=VARCHAR}
			  AND gmid.DAY_ST= #{daySt,jdbcType=DATE}
			  AND gmid.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
		GROUP BY gmid.MEMBER_NO ,gmid.DAY_ST
		) a
		ON gm.MEMBER_NO = a.MEMBER_NO
		where (gm.STATUS='NORMAL' OR gm.STATUS='FREEZE')
			  AND gm.#{shopNo,jdbcType=VARCHAR} 
		      AND gm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
    	order by total DESC, gm.CREATE_DATE DESC 
    </select>
    
    <select id="findCountPmAddByGmDay" resultType="long">
    	select COUNT(1)
    	from person_member
    	where member_no_gm = #{memberNo}
    	and date_format(CREATE_DATE,'%Y-%m-%d') = date_format(#{date},'%Y-%m-%d')
    </select>
    
    <select id="findNewPmCount" resultType="int" parameterType="com.lj.business.member.dto.FindNewPmCountDto">
    	select count(*)
    	from person_member
    	where MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR} 
    		  AND MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
    	<![CDATA[	  
    		  AND CREATE_DATE >= #{beginDate,jdbcType=TIMESTAMP}
    		  AND CREATE_DATE <= #{endDate,jdbcType=TIMESTAMP}
    	]]> 
    </select>
    
    <select id="findCountPmByType" resultType="integer">
    	SELECT count(1)
		FROM person_member pm
		LEFT JOIN pm_type pt ON pm.PM_TYPE_CODE = pt.`CODE`
		WHERE pm.MEMBER_NO_GM = #{memberNo,jdbcType=VARCHAR}
			AND pt.PM_TYPE_TYPE = #{pmTypeType,jdbcType=VARCHAR} 
    </select>
    
    <!-- 根据导购编号和商户号查询客户信息	create by 杨杰 -->
    <select id="findMemberRecord" resultType="com.lj.business.member.dto.FindMemberInfoReturn" parameterType="com.lj.business.member.dto.FindMemberRecord">
    	SELECT 
		pmb.NO_WX AS noWx,
		pmb.HEAD_ADDRESS AS headAddress,
		pmb.NICK_NAME_WX AS nickNameWx,
		pm.NICK_NAME_REMARK_WX AS nickNameRemarkWx,
		pm.NICK_NAME_REMARK_LOCAL AS nickNameRemarkLocal
		FROM person_member pm join person_member_base pmb on pm.MEMBER_NO = pmb.MEMBER_NO 
		where 
		pm.MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR} 
		AND pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
		AND pmb.NO_WX IS NOT NULL
		AND pm.NICK_NAME_REMARK_LOCAL IS NOT NULL
    </select>
    
    <select id="findGroupCountByDay" resultType="com.lj.business.member.dto.CountPersonMemberReturn">
    	SELECT date_format(pm.CREATE_DATE,'%Y-%m-%d') createDate,COUNT(DISTINCT pm.MEMBER_NO) numAdd
		FROM person_member pm LEFT JOIN person_member_base pmb ON pm.member_no = pmb.member_no
		WHERE pm.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR}
		<![CDATA[
		AND date_format(pm.CREATE_DATE,'%Y-%m-%d') >= #{startTime} AND date_format(pm.CREATE_DATE,'%Y-%m-%d') <= #{endTime}
		]]> 
		GROUP BY date_format(pm.CREATE_DATE,'%Y-%m-%d')
    </select>
    
    <select id="findIntentionMemberNo" resultType="java.lang.String" parameterType="java.lang.String" >
    	SELECT DISTINCT pm.MEMBER_NO
		FROM PERSON_MEMBER pm, 
		PM_TYPE pt
    	WHERE pt.CODE = pm.PM_TYPE_CODE AND pt.MERCHANT_NO = #{merchantNo,jdbcType=VARCHAR} AND pt.TYPE_NAME LIKE '意向%'
    </select>
    <select id="findPersonMemberByNo" resultMap="findListResultMap">
    			select * from  PERSON_MEMBER where member_no = #{memberNo}
    </select>
    
	<select id="findPersonMemberByNoAndGM" resultMap="findListResultMap" parameterType="com.lj.business.member.dto.FindPersonMember">
      select * from PERSON_MEMBER
      <where>
      <if test="memberNo != null  and memberNo !=''" >
        and MEMBER_NO = #{memberNo}
      </if>
      <if test="memberNoGm != null and memberNoGm !='' ">
		and MEMBER_NO_GM = #{memberNoGm,jdbcType=VARCHAR}
	  </if>
	  <if test="shopWx != null and shopWx !='' ">
		and SHOP_WX = #{shopWx,jdbcType=VARCHAR}
	  </if>
	  </where>
    </select>
    
    <select id="findPersonMemberByWx" resultType="string">
    	select gm.NO_WX from PERSON_MEMBER pm
		join person_member_base pmb on pm.MEMBER_NO = pmb.MEMBER_NO
		join guid_member gm on pm.MEMBER_NO_GM = gm.MEMBER_NO
		where pmb.NO_WX = #{noWx}
    </select>
    

    <select id="findPersonMemberByNoWxAndShopWx" resultMap="findListResultMap">
    			select 
    				<!--   	客户信息 -->
				     pm.CODE, pm.MEMBER_NO, pm.MEMBER_NAME, pm.MEMBER_NO_GM, pm.MEMBER_NAME_GM,pm.MERCHANT_NO,pm.NICK_NAME_REMARK_WX,
				    pm.MERCHANT_NAME, pm.SPRUCE_UP, pm.HOUSES, pm.KEEP_EYE, pm.URGENCY_PM, pm.BOM_CODE, pm.BOM_NAME, pm.CLIENT_SPECIAL,
				    pm.CONSUME_FREQUENCY,pm.CONSUME_FREQUENCY,pm.ADD_TYPE,
				    pm.CREATE_ID, pm.CREATE_DATE, pm.UPDATE_ID, pm.UPDATE_DATE, pm.REMARK4, pm.REMARK3, pm.REMARK2, pm.REMARK,pm.BRAND_COMPARE
				    <!-- 		客户分类 -->
					,pm.PM_TYPE_CODE,pm.PM_TYPE_NAME,pmb.HEAD_ADDRESS
    			from  PERSON_MEMBER  pm 
    			LEFT JOIN person_member_base pmb ON pm.member_no = pmb.member_no   
    			where pmb.no_wx = #{noWx} 
    			and pm.shop_wx =#{shopWx}
    			and pm.WX_FRIENDS = 1
    			order by pm.CREATE_DATE desc
    			limit 1
    </select>
    
    <!-- 更新客户基础数据关联的所有导购客户关联数据PM表 -->
    <update id="updateVersionAllMember">
    	update PERSON_MEMBER 
    	   set VERSION = #{version}
    	 where MEMBER_NO = #{memberNo}
    </update>
    
   <!-- 更新客户基础数据关联的所有导购客户关联数据PM表 -->
    <update id="updateVersionAllMemberByGm">
    	update PERSON_MEMBER 
    	   set VERSION=REPLACE(unix_timestamp(current_timestamp(3)),'.','')
    	 where MEMBER_NO_GM = #{memberNoGm}
    </update>

	<select id="findPageByMemberNoAndShopNo" parameterType="com.lj.business.member.dto.MemberNoAndShopNoPageDto" resultMap="FindPageByMemberNoAndShopNoMap">
    SELECT s.s.s.LOGO_ADDR,s.ADDR_INFO,gm.MEMBER_NO,gm.MEMBER_NAME,gm.MOBILE,gm.NO_WX,gm.QCORD
		FROM   person_member pm
		      JOIN guid_member gm ON pm.MEMBER_NO_GM = gm.MEMBER_NO
		      JOIN shop s ON s.pm.SHOP_NO
		WHERE s.#{shopNo} and gm.STATUS='NORMAL'
		<if test="memberNo != null  and memberNo !=''" >
	        and pm.MEMBER_NO = #{memberNo,jdbcType=VARCHAR}
	     </if>
	     <if test="guidNo != null  and guidNo !=''" >
	        and gm.MEMBER_NO = #{guidNo,jdbcType=VARCHAR}
	     </if>
		
    </select>
    
    <select id="findListByShopNo" resultType="int">
    	select count(*)
    	from person_member
    	where #{shopNo} and MEMBER_NO = #{memberNo}
    </select>
    
    
    
    <!-- 微软CRM获取新增/更新的意向客户信息 -->
   <select id="getCustomerInfo" resultType="map" parameterType="map" >
	  SELECT  
	  <!--   	客户信息 -->
	    pm.MEMBER_NAME customername
	    ,(SELECT gm.MOBILE from guid_member gm WHERE gm.MEMBER_NO = pm.MEMBER_NO_GM) gmphone
	    , pm.MEMBER_NAME_GM gmname, pm.SHOP_NO shopid, pmb.SEX sex, pmb.MOBILE customerphone
	    ,pmb.PROVINCE_CODE provinceid,pmb.CITY_CODE cityid,pmb.CITY_AREA_CODE regionid
	    ,pmb.ADDRESS address, pm.HOUSES house, pm.SPRUCE_UP spruceup, pm.URGENCY_PM urgencypm
	    , pm.BOM_NAME bomname,pm.CONTACT_DATE_LAST contactdatelast, pm.CLIENT_SPECIAL clientspecial
	    ,pm.CONSUME_FREQUENCY consumefrequency,pm.EXP_TIME exptime, pm.UPDATE_DATE updateDate
	     ,s.SHOP_NO_MERCHANT shopnomerchant,pmb.WX_OPENID wxopenid, pm.CODE gmpmcode
	  
	  FROM person_member pm
	  INNER JOIN person_member_base  pmb ON pm.MEMBER_NO=pmb.MEMBER_NO
	  LEFT JOIN pm_type pt ON pt.CODE = pm.PM_TYPE_CODE
	  LEFT JOIN guid_member gm ON pm.MEMBER_NO_GM=gm.MEMBER_NO
	  LEFT JOIN shop s ON s.gm.SHOP_NO
	  <!-- 过滤有电话的客户 -->
	  WHERE (pmb.MOBILE IS NOT NULL AND pmb.MOBILE !='')
	  <!-- 过滤意向客户，排除非意向客户 -->
	  AND pt.TYPE_NAME like CONCAT('意向客户','%' )
		<if test="merchantNo != null and merchantNo !='' ">
			and pm.MERCHANT_NO = #{merchantNo}
		</if>
		<if test="updateDate != null ">
			<![CDATA[and pm.UPDATE_DATE >= #{updateDate}]]>
		</if>
		ORDER BY pm.UPDATE_DATE ${sortDir}
  </select>
  
  <!-- 商户下按终端统计客户情况 -->
  <select id="memberStsGroupByShop" resultType="com.lj.business.member.dto.PersonMemberStsGroupByShop">
  	select t.shop_no shopNo, t.shop_name shopName, t.shop_no_merchant shopNoMerchant, 
  	 	   c.dealer_code dealerCode, t.company_no companyNo, t.company_name companyName, 
  		   p.total_count totalCount, p.today_count todayCount 
  	  from shop t
  	  left join branch_company c
  	    on t.company_no = c.company_no
  	  left join (
	  	  	select  count(*) total_count, sum(if(CREATE_DATE >= #{beginTime}, 1, 0)) today_count 
	  	  	  from person_member
	  	     where merchant_no = #{merchantNo}
	  	       <![CDATA[and create_date <= #{endTime}]]>
	  	     group by shop_no
  	  	   ) p
  	  	on t.p.shop_no  
  	 where t.member_no_merchant = #{merchantNo}
  	   and t.company_no is not null
  	 <!-- 查询endTime之前创建的终端 -->
  	 <![CDATA[
  	   and t.create_date <= #{endTime}
  	 ]]>
  </select>
  
  <!-- 查询未联系客户列表-begin -->
  <sql id="findUnchatMember_condition">
	<where>
		<if test="memberName != null and memberName !='' ">
			and pm.MEMBER_NAME like CONCAT('%',#{memberName,jdbcType=VARCHAR},'%' )
		</if>
		<if test="mobile != null and mobile !='' ">
			and pmb.MOBILE like CONCAT('%',#{mobile,jdbcType=VARCHAR},'%' )
		</if>
		<if test="memberSrc != null and memberSrc !='' "><!--前端传 WITHOUT代表无来源 -->
			<if test='memberSrc == "WITHOUT"'>
				and pmb.MEMBER_SRC is null
			</if>
			<if test='memberSrc != "WITHOUT"'>
				and pmb.MEMBER_SRC = #{memberSrc}
			</if>
		</if>
		<if test="registerBeginTime != null">
		<![CDATA[and pm.CREATE_DATE >= #{registerBeginTime}]]>
		</if>
		<if test="registerEndTime != null"> 
			<![CDATA[and pm.CREATE_DATE <= #{registerEndTime}]]>
		</if>
		<if test="merchantNo != null and merchantNo !='' ">
			and pm.MERCHANT_NO = #{merchantNo}
		</if>
	</where>
  </sql>
  <sql id="findUnchatMemberByChat_condition">
	<where>
		im.member_no is not null
		and im.status = 2 
		<if test="chatBeginTime != null">
		<![CDATA[and im.chat_time >= #{chatBeginTime}]]>
		</if>
		<if test="chatEndTime != null"> 
			<![CDATA[and im.chat_time <= #{chatEndTime}]]>
		</if>
		<if test="merchantNo != null and merchantNo !='' ">
			and im.MERCHANT_NO = #{merchantNo}
		</if>
	</where>
  </sql>
  <select id="findUnchatMemberList" parameterType="com.lj.business.member.dto.FindUnchatMemberPage" resultType="com.lj.business.member.dto.FindUnchatMemberPageReturn">
  	SELECT pm.MEMBER_NO memberNo,pm.MEMBER_NAME memberName, pm.MEMBER_NO_GM memberNoGm, 
		   pm.SHOP_NO shopNo,pm.SHOP_NAME shopName, pm.CREATE_DATE createDate,
		   pmb.MOBILE mobile,pmb.MEMBER_SRC memberSrc,pmb.NICK_NAME_WX nickNameWx,pmb.HEAD_ADDRESS headAddress, 
		   pmb.NO_WX noWx,pmb.NO_WX_ALIAS noWxAlias <!-- , im.chat_count chatCount -->
      FROM person_member pm  
      LEFT JOIN person_member_base pmb  
        on pm.MEMBER_NO=pmb.MEMBER_NO and pm.WX_FRIENDS = 1
  	<include refid="findUnchatMember_condition"/>
     ORDER BY pm.CREATE_DATE desc
     limit ${start},${limit}
  </select>
  <select id="findUnchatMemberCount" parameterType="com.lj.business.member.dto.FindUnchatMemberPage" resultType="int">
  	SELECT count(*)
      FROM person_member pm  
      LEFT JOIN person_member_base pmb  
        on pm.MEMBER_NO=pmb.MEMBER_NO and pm.WX_FRIENDS = 1
  	<include refid="findUnchatMember_condition"/>
  </select>
  <!-- 查询未联系客户列表-end -->
  
  <select id="findWxPmCountByGm" parameterType="com.lj.business.member.dto.wxPmFollow.FindWxPmByGm" resultType="long">
  	SELECT
		COUNT(DISTINCT pm.MEMBER_NO)
	FROM person_member pm 
	<where>
		pm.WX_FRIENDS = 1
		<if test="memberNoGm != null and memberNoGm !='' ">
			AND pm.MEMBER_NO_GM = #{memberNoGm}
		</if>
		<if test="addBeginTime != null">
			<![CDATA[and pm.CREATE_DATE >= #{addBeginTime}]]>
		</if>
		<if test="addEndTime != null">
			<![CDATA[and pm.CREATE_DATE <= #{addEndTime}]]>
		</if>
	</where>
  </select>
  
  <select id="findWxPmByGm" parameterType="com.lj.business.member.dto.wxPmFollow.FindWxPmByGm" resultMap="findListResultMap">
  	SELECT
		<include refid="Base_Column_List" />
	FROM person_member pm 
	<where>
		WX_FRIENDS = 1
		<if test="memberNoGm != null and memberNoGm !='' ">
			AND MEMBER_NO_GM = #{memberNoGm}
		</if>
		<if test="addBeginTime != null">
			<![CDATA[and CREATE_DATE >= #{addBeginTime}]]>
		</if>
		<if test="addEndTime != null">
			<![CDATA[and CREATE_DATE <= #{addEndTime}]]>
		</if>
	</where>
  </select>
    	<!-- 转移客户 -->
	<update id="updateFriendsWithTransfer" parameterType="map">
	   update person_member set MEMBER_NO_GM=#{rediectGmNo},MEMBER_NAME_GM=#{newGmName},version=#{version} 
	   where MEMBER_NO_GM=#{sourceGmNo} 
	   and  MEMBER_NO=#{memberNo}
	   and SHOP_WX = #{noWxGm}
	</update>
	
	<!-- 取消客户绑定 -->
	<update id="updateCanclePersonMember" parameterType="map">
		   delete from person_member  
		   where MEMBER_NO_GM=#{gmNo} 
		   and MEMBER_NO in (select MEMBER_NO from person_member_base where NO_WX=#{wxNo} )
		   and SHOP_WX = #{noWxGm}
	</update>
	
	<update id="updatePmTypeAllMember" >
		   update PERSON_MEMBER 
	    	   set  PM_TYPE_NAME = #{pmTypeName}
	    	   ,VERSION=REPLACE(unix_timestamp(current_timestamp(3)),'.','')
   	 	 	where MERCHANT_NO = #{merchantNo} and PM_TYPE_CODE=#{pmTypeCode}
	</update>
	
	<!-- 批量分组 -->
	<update id="changePmTypeBatch" >
		   update PERSON_MEMBER 
	    	   set  PM_TYPE_NAME = #{pmTypeName},PM_TYPE_CODE = #{pmTypeCode}
	    	   ,VERSION=REPLACE(unix_timestamp(current_timestamp(3)),'.','')
   	 	 	where CODE in(
   	 	 	<foreach item="item" index="index" collection="codePms" separator=","> #{item} </foreach> 
              ) 
	</update>
	
    
    <select id="findPersonMemberByMoblieAndShopWx" resultMap="findListResultMap" parameterType="com.lj.business.member.dto.FindPersonMember">
	  	select pm.* from person_member pm join person_member_base  pb on pm.MEMBER_NO=pb.MEMBER_NO  
		<where>
      	<if test="merchantNo != null  and merchantNo !=''" >
		and pm.MERCHANT_NO=#{merchantNo}
		</if>
			<if test="shopWx != null  and shopWx !=''" >
		  and pm.SHOP_WX=#{shopWx}
		</if>
		<if test="mobile != null  and mobile !=''" >
		  and pb.MOBILE=#{mobile}
		</if>
	  	</where>
	  	limit 1
    </select>
	<select id="findPersonMemberCodeByMemberNo" resultType="java.lang.String" parameterType="java.lang.String">
      select CODE from PERSON_MEMBER
      <where>
        and MEMBER_NO = #{memberNo}
	  </where>
	  limit 1
    </select>
    
    <delete id="delete" parameterType="com.lj.business.member.dto.UpdatePersonMember">
    	delete from person_member
    	where MERCHANT_NO=#{merchantNo}
    	and SHOP_WX=#{shopWx}
    </delete>
    
    <!-- 乐莎莎 查导购好友 2019年5月13日 -->
  <resultMap id="findPersonMemberByMobliesMap" type="com.lj.business.member.dto.PersonMemberDto" >
    <id column="CODE" property="code" jdbcType="VARCHAR" />
    <result column="MEMBER_NO" property="memberNo" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME" property="memberName" jdbcType="VARCHAR" />
    <result column="MEMBER_NO_GM" property="memberNoGm" jdbcType="VARCHAR" />
    <result column="MEMBER_NAME_GM" property="memberNameGm" jdbcType="VARCHAR" />
    <result column="MERCHANT_NO" property="merchantNo" jdbcType="VARCHAR" />
    <result column="MERCHANT_NAME" property="merchantName" jdbcType="VARCHAR" />
    <result column="SHOP_WX" property="shopWx" jdbcType="VARCHAR" />
    
    <result column="NO_WX" property="noWx" jdbcType="VARCHAR" />
    <result column="NO_WX_ALIAS" property="noWxAlias" jdbcType="VARCHAR" />
    <result column="NICK_NAME_WX" property="nickNameWx" jdbcType="VARCHAR" />
    <result column="HEAD_ADDRESS" property="headAddress" jdbcType="VARCHAR" />
    <result column="MOBILE" property="mobile" jdbcType="VARCHAR" />
  </resultMap> 
   
   <!-- 乐莎莎 查导购好友  2019年5月13日 -->
   <select id="findPersonMemberByMoblies" resultMap="findPersonMemberByMobliesMap" parameterType="com.lj.business.member.dto.PersonMemberDto">
		SELECT
		pm.MERCHANT_NO,pm.code,pm.MEMBER_NO_GM,pm.MEMBER_NAME_GM,pm.MEMBER_NO,pm.MEMBER_NAME,pm.SHOP_WX
		,pb.NO_WX,pb.NO_WX_ALIAS,pb.NICK_NAME_WX,pb.HEAD_ADDRESS, pb.MOBILE
		from person_member pm
		JOIN person_member_base pb on pm.MEMBER_NO=pb.MEMBER_NO
		and pm.MERCHANT_NO=#{merchantNo} 
		<if test="memberNoGm != null and memberNoGm!=''">
			and pm.MEMBER_NO_GM=#{memberNoGm}
		</if>
		<if test="shopWx != null and shopWx!=''">
			and pm.SHOP_WX=#{shopWx}
		</if>
		<if test="mobile != null and mobile!=''">
			and pb.MOBILE =#{mobile}
		</if>
	
		<if test="mobiles != null and mobiles.size() > 0">
			and pb.MOBILE in
			<foreach item="item" index="index" collection="mobiles"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		 ORDER BY pb.MOBILE 
    </select>
    
    <select id="findTotalMemberPhone" resultType="java.lang.Integer">
    	SELECT COUNT(temp.MOBILE) FROM
		(SELECT pm.MEMBER_NAME,pm.MEMBER_NO,pm.MEMBER_NAME_GM,
		pm.MEMBER_NO_GM,pmb.MOBILE,pmb.add_mobile_date 
		FROM person_member pm LEFT JOIN person_member_base pmb ON pm.MEMBER_NO = pmb.MEMBER_NO
		<where>
			<if test="mapPhone.memberNoGm != null and mapPhone.memberNoGm != ''">
				MEMBER_NO_GM = #{mapPhone.memberNoGm,jdbcType=VARCHAR}
			</if>
			<if test="mapPhone.startTime != null">
				<![CDATA[AND pmb.add_mobile_date >= #{mapPhone.startTime}]]>
			</if>
			<if test="mapPhone.endTime != null"> 
				<![CDATA[AND pmb.add_mobile_date <= #{mapPhone.endTime}]]>
			</if>
				AND pmb.MOBILE IS NOT NULL
		</where>
		) temp 
    </select>
    
    <select id="findTotalMember" resultType="java.lang.Integer">
    	SELECT COUNT(MEMBER_NO) FROM person_member
    	<where>
    		<if test="map.memberNoGm != null and map.memberNoGm != ''">
    			MEMBER_NO_GM = #{map.memberNoGm,jdbcType=VARCHAR}
    		</if>
    		<if test="map.startTime != null">
				<![CDATA[AND create_date >= #{map.startTime}]]>
			</if>
			<if test="map.endTime != null"> 
				<![CDATA[AND create_date <= #{map.endTime}]]>
			</if>
    	</where>
    </select>
</mapper>